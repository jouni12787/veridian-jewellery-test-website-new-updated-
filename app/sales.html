<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veridian Atelier • Sales Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="../assets/logo-website-test.jpg">
  <link rel="apple-touch-icon" href="../assets/logo-website-test.jpg">
  <link rel="manifest" href="../manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2596be">
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://api.gold-api.com; child-src 'self' https://drive.google.com https://*.googleusercontent.com; frame-src 'self' https://drive.google.com https://*.googleusercontent.com; object-src 'none'; base-uri 'self'; frame-ancestors 'self'"
  >
  <script>
    window.__redirectToLogin = function redirectToLogin() {
      window.location.replace('../index.html');
    };

    window.handleUnauthorized = async function handleUnauthorized() {
      try {
        await fetch('../api/logout', { method: 'POST', credentials: 'include' });
      } catch (error) {
        console.warn('Failed to notify logout.', error);
      }
      window.__redirectToLogin();
    };

    (async () => {
      try {
        const response = await fetch('../api/session', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Session invalid');
        }
        const data = await response.json();
        if (!data?.authenticated) {
          throw new Error('Unauthenticated');
        }
      } catch (error) {
        window.__redirectToLogin();
      }
    })();
  </script>
  <style>
    :root {
      --pad: 18px;
      --gold-primary: #2596be;
      --gold-secondary: #2596be;
      --gold-dark: #1f7fa0;
      --gold-light: #e6f6fb;
      --ivory: #fafdff;
      --charcoal: #1f2a30;
      --warm-gray: #4f6b78;
      --accent-gold: #2596be;
      --bg: radial-gradient(circle at 10% 0%, rgba(37, 150, 190, 0.15) 0%, rgba(37, 150, 190, 0.05) 55%, #ffffff 100%);
      --glass: rgba(255, 255, 255, 0.92);
      --card-border: rgba(37, 150, 190, 0.3);
      --accent: var(--gold-primary);
      --accent-dark: var(--gold-dark);
      --text: var(--charcoal);
      --muted: var(--warm-gray);
      --shadow: 0 18px 40px -24px rgba(37, 150, 190, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: calc(var(--pad) * 1.2) var(--pad) calc(var(--pad) * 1.6);
    }
    body.photo-viewer-open { overflow: hidden; }
    .page {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }
    .language-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.82);
      border: 1px solid rgba(37, 150, 190, 0.2);
      box-shadow: inset 0 0 0 1px rgba(37, 150, 190, 0.12);
    }
    .language-toggle select {
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-dark);
      cursor: pointer;
      outline: none;
      appearance: none;
      padding: 0;
    }
    .language-toggle select option {
      color: var(--text);
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .brand-logo {
      height: 56px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 6px 16px rgba(37, 150, 190, 0.25));
    }
    .page-nav {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(229, 246, 251, 0.78));
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: 0 18px 32px -22px rgba(37, 150, 190, 0.45);
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x proximity;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      backdrop-filter: blur(12px);
    }
    .page-nav::-webkit-scrollbar { display: none; }
    .nav-link {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--accent-dark);
      text-decoration: none;
      transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      background: rgba(255, 255, 255, 0.82);
      scroll-snap-align: center;
      min-width: max-content;
      box-shadow: inset 0 0 0 1px rgba(37, 150, 190, 0.12);
    }
    .nav-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.45);
    }
    .nav-link:focus-visible {
      outline: 2px solid rgba(37, 150, 190, 0.55);
      outline-offset: 2px;
    }
    .nav-link:active {
      transform: scale(0.98);
    }
    .nav-link.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      box-shadow: 0 14px 30px -18px rgba(37, 150, 190, 0.6);
    }
    .hero-title {
      margin: 0;
      font-family: 'Playfair Display', 'Times New Roman', serif;
      font-size: clamp(1.6rem, 3.8vw, 2.4rem);
      letter-spacing: 0.02em;
      color: var(--text);
    }
    .hero-subtitle {
      margin: 0;
      font-size: clamp(0.95rem, 2vw, 1.05rem);
      color: var(--muted);
      max-width: 620px;
    }
    .glass-card {
      background: var(--glass);
      border: 1px solid var(--card-border);
      border-radius: 28px;
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .filter-card {
      display: grid;
      gap: 14px;
    }
    .filter-form {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .filter-input-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-filters {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-filter-btn {
      background: rgba(255, 255, 255, 0.92);
      color: var(--accent-dark);
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: none;
    }
    .quick-filter-btn:hover {
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.35);
    }
    .quick-filter-btn.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 14px 30px -20px rgba(37, 150, 190, 0.55);
    }
    .filter-form label {
      font-weight: 600;
      font-size: 0.95rem;
      font-family: 'Playfair Display', serif;
    }
    .filter-form input[type="date"] {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(37, 150, 190, 0.25);
      background: rgba(255, 255, 255, 0.95);
      font-size: 0.98rem;
      font-family: inherit;
      color: var(--text);
    }
    button {
      padding: 10px 16px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      border: none;
      box-shadow: 0 14px 32px -18px rgba(37, 150, 190, 0.45);
      transition: transform 150ms ease, box-shadow 150ms ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px -18px rgba(37, 150, 190, 0.55);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: none;
      background: rgba(37, 150, 190, 0.35);
    }
    .clear-btn {
      background: rgba(255, 255, 255, 0.92);
      color: var(--accent-dark);
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: none;
    }
    .clear-btn:hover {
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.35);
    }
    .sales-stats {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .table-card {
      display: grid;
      gap: 18px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid rgba(37, 150, 190, 0.2);
      background: rgba(255, 255, 255, 0.75);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 880px;
    }
    thead {
      background: rgba(37, 150, 190, 0.1);
    }
    th, td {
      text-align: left;
      padding: 14px;
      border-bottom: 1px solid rgba(37, 150, 190, 0.18);
      font-size: 0.95rem;
    }
    th {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      font-weight: 600;
    }
    tbody tr:hover {
      background: rgba(255, 255, 255, 0.6);
    }
    .notes-cell {
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 320px;
    }
    .photo-cell { width: 110px; }
    .photo-thumb {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 68px;
      height: 68px;
      padding: 0;
      appearance: none;
      border: 1px solid rgba(37, 150, 190, 0.35);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 12px 24px -18px rgba(44, 44, 44, 0.35);
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.2s ease;
    }
    .photo-thumb.loading img { opacity: 0; }
    .photo-thumb.loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(37, 150, 190, 0.45);
      border-top-color: transparent;
      animation: photo-spin 0.8s linear infinite;
    }
    .photo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
      transition: opacity 0.2s ease;
    }
    .photo-thumb:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px -20px rgba(44, 44, 44, 0.4);
    }
    .photo-thumb:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .photo-thumb--empty {
      cursor: default;
      background: rgba(255, 255, 255, 0.65);
      box-shadow: none;
      border-style: dashed;
    }
    .photo-thumb--empty span {
      font-size: 0.72rem;
      color: var(--muted);
      padding: 0 6px;
      text-align: center;
    }
    .photo-thumb--empty:hover { transform: none; }
    @keyframes photo-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .photo-viewer {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .photo-viewer[hidden] { display: none; }
    .photo-viewer__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(44, 44, 44, 0.45);
      backdrop-filter: blur(4px);
    }
    .photo-viewer__content {
      position: relative;
      z-index: 1;
      margin: 0;
      display: grid;
      gap: 12px;
      max-width: min(90vw, 520px);
      max-height: 85vh;
      padding: clamp(18px, 4vw, 26px);
      border-radius: 26px;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 28px 64px -24px rgba(0, 0, 0, 0.45);
      text-align: center;
    }
    .photo-viewer__content img {
      width: 100%;
      max-height: 62vh;
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 20px 44px -26px rgba(0, 0, 0, 0.4);
    }
    .photo-viewer__close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: rgba(44, 44, 44, 0.82);
      color: #fff;
      font-size: 1.35rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.18s ease, background 0.2s ease;
    }
    .photo-viewer__close:hover {
      transform: scale(1.05);
      background: rgba(44, 44, 44, 0.94);
    }
    .photo-viewer__close:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .photo-viewer__content figcaption {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }
    .photo-viewer__status {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    @media (max-width: 640px) {
      .photo-thumb {
        width: 58px;
        height: 58px;
      }
      .photo-viewer {
        padding: 18px;
      }
      .photo-viewer__content {
        padding: clamp(16px, 6vw, 24px);
        gap: 10px;
      }
      .photo-viewer__close {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
      }
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .status-sold {
      background: rgba(26, 143, 85, 0.12);
      color: #1a8f55;
      border: 1px solid rgba(26, 143, 85, 0.25);
    }
    .status-recorded {
      background: rgba(37, 150, 190, 0.12);
      color: var(--gold-dark);
      border: 1px solid rgba(37, 150, 190, 0.28);
    }
    .loading {
      color: var(--muted);
      font-size: 0.95rem;
    }
    .empty-state {
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
    }
    body.rtl {
      direction: rtl;
      font-family: 'Amiri', 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
    }
    body.rtl header {
      text-align: right;
      align-items: stretch;
    }
    body.rtl .header-top {
      justify-content: space-between;
    }
    body.rtl .page-nav {
      direction: rtl;
      justify-content: flex-end;
    }
    body.rtl .filter-form,
    body.rtl .quick-filters {
      flex-direction: row-reverse;
    }
    body.rtl .clear-btn {
      margin-left: 0;
      margin-right: auto;
    }
    body.rtl table {
      direction: rtl;
    }
    body.rtl th,
    body.rtl td {
      text-align: right;
    }
    body.rtl td::before {
      text-align: left;
    }
    .error-message {
      color: #d84a63;
      font-weight: 600;
      font-size: 0.95rem;
    }
    @media (max-width: 720px) {
      header {
        text-align: center;
        align-items: center;
      }
      .header-top {
        width: 100%;
        display: grid;
        justify-items: center;
      }
      body.rtl .header-top {
        justify-items: center;
      }
      .page-nav {
        width: 100%;
        justify-content: flex-start;
      }
      .brand-logo { height: 46px; }
      table {
        min-width: 100%;
      }
      th, td {
        padding: 12px;
        font-size: 0.9rem;
      }
      .notes-cell {
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-top">
        <img src="../assets/logo-website-test.jpg" alt="Veridian Atelier logo" class="brand-logo" />
        <nav class="page-nav" aria-label="Workspace navigation">
          <a class="nav-link" href="./index.html" data-i18n="navScanner">Scanner</a>
          <a class="nav-link" href="./items.html" data-i18n="navInventory">Inventory</a>
          <a class="nav-link active" href="./sales.html" aria-current="page" data-i18n="navSales">Sales log</a>
          <a class="nav-link" href="./purchases.html" data-i18n="navPurchases">Purchase log</a>
          <a class="nav-link" href="./statement.html" data-i18n="navStatement">Gold statement</a>
        </nav>
        <div class="language-toggle">
          <label for="languageToggle" class="sr-only" data-i18n="languageLabel">Language</label>
          <select id="languageToggle" aria-label="Select language">
            <option value="en">English</option>
            <option value="ar">العربية</option>
          </select>
        </div>
      </div>
      <h1 class="hero-title" data-i18n="heroTitle">Sales log</h1>
      <p class="hero-subtitle" data-i18n="heroSubtitle">Review every sold piece, who sold it, and for how much. Filter the log by sale date to audit a specific day.</p>
    </header>

    <section class="glass-card filter-card" id="filtersSection" aria-label="Sales filters">
      <form id="filterForm" class="filter-form" novalidate>
        <label for="soldDateFilter" data-i18n="filterLabel">Filter by sold date</label>
        <div class="filter-input-group">
          <input type="date" id="soldDateFilter" name="soldDate" />
          <div class="quick-filters" id="quickFiltersGroup" role="group" aria-label="Quick sold date filters">
            <button type="button" class="quick-filter-btn" data-quick-filter="today" data-i18n="filterToday">Today</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="yesterday" data-i18n="filterYesterday">Yesterday</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="week" data-i18n="filterWeek">This week</button>
          </div>
        </div>
        <button type="button" id="clearFilterBtn" class="clear-btn" data-i18n="filterClear">Clear</button>
      </form>
      <p id="salesStats" class="sales-stats" data-i18n="statsLoading" data-i18n-dynamic>Loading sales…</p>
    </section>

    <section class="glass-card table-card" id="tableSection" aria-label="Sales log">
      <div id="salesLoading" class="loading" role="status" data-i18n="loadingMessage" data-i18n-dynamic>Loading sales history…</div>
      <div id="salesError" class="error-message" hidden role="alert"></div>
      <p id="salesEmpty" class="empty-state" hidden data-i18n="emptyState" data-i18n-dynamic>No sales recorded yet.</p>
      <div id="salesTableWrapper" class="table-wrapper" hidden>
        <table class="sales-table">
          <thead>
            <tr>
              <th scope="col" data-i18n="tableSku">SKU</th>
              <th scope="col" data-i18n="tablePiece">Piece</th>
              <th scope="col" data-i18n="tablePhoto">Photo</th>
              <th scope="col" data-i18n="tableWeight">Weight (g)</th>
              <th scope="col" data-i18n="tableKarat">Karat</th>
              <th scope="col" data-i18n="tableStatus">Status</th>
              <th scope="col" data-i18n="tableSoldPrice">Sold price</th>
              <th scope="col" data-i18n="tableSoldDate">Sold date</th>
              <th scope="col" data-i18n="tableSoldBy">Sold by</th>
              <th scope="col" data-i18n="tableNotes">Notes</th>
            </tr>
          </thead>
          <tbody id="salesTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div
    id="photoViewer"
    class="photo-viewer"
    hidden
    role="dialog"
    aria-modal="true"
    aria-labelledby="photoViewerCaption"
    tabindex="-1"
  >
    <div id="photoViewerBackdrop" class="photo-viewer__backdrop" data-close="photoViewer"></div>
    <figure class="photo-viewer__content">
      <button
        type="button"
        id="photoViewerClose"
        class="photo-viewer__close"
        aria-label="Close photo"
        data-close="photoViewer"
      >&times;</button>
      <img id="photoViewerImage" alt="" decoding="async" hidden />
      <figcaption id="photoViewerCaption" data-i18n="photoViewerCaption">Sold piece photo</figcaption>
      <p
        id="photoViewerStatus"
        class="photo-viewer__status"
        hidden
        data-i18n="photoViewerStatusLoading"
        data-i18n-dynamic
      >Loading photo…</p>
    </figure>
  </div>

  <script>
    (function () {
      const DATE_FORMAT = { year: 'numeric', month: 'short', day: 'numeric' };
      const DEFAULT_CONFIG = {
        authEndpoint: '/api/auth',
        inventoryEndpoint: '/api/inventory',
        salesEndpoint: '/api/sales',
        whatsappNumber: '+96179030257',
        goldPriceUrl: 'https://api.gold-api.com/price/XAU'
      };

      const APP_CONFIG = Object.freeze({
        ...DEFAULT_CONFIG,
        ...(window.APP_CONFIG && typeof window.APP_CONFIG === 'object' ? window.APP_CONFIG : {})
      });

      const SALES_ENDPOINT = APP_CONFIG.salesEndpoint;

      const statsEl = document.getElementById('salesStats');
      const tableBody = document.getElementById('salesTableBody');
      const tableWrapper = document.getElementById('salesTableWrapper');
      const emptyEl = document.getElementById('salesEmpty');
      const loadingEl = document.getElementById('salesLoading');
      const errorEl = document.getElementById('salesError');
      const dateFilter = document.getElementById('soldDateFilter');
      const clearBtn = document.getElementById('clearFilterBtn');
      const quickFilterButtons = document.querySelectorAll('[data-quick-filter]');
      const photoViewer = document.getElementById('photoViewer');
      const photoViewerImage = document.getElementById('photoViewerImage');
      const photoViewerCaption = document.getElementById('photoViewerCaption');
      const photoViewerStatus = document.getElementById('photoViewerStatus');
      const photoViewerClose = document.getElementById('photoViewerClose');
      const photoViewerBackdrop = document.getElementById('photoViewerBackdrop');
      const languageToggle = document.getElementById('languageToggle');
      const filtersSection = document.getElementById('filtersSection');
      const tableSection = document.getElementById('tableSection');
      const quickFiltersGroup = document.getElementById('quickFiltersGroup');
      const i18nElements = document.querySelectorAll('[data-i18n]');

      if (photoViewerStatus) {
        photoViewerStatus.dataset.state = 'loading';
      }

      const translations = {
        en: {
          pageTitle: 'Veridian Atelier • Sales Log',
          languageLabel: 'Language',
          languageSelectAria: 'Select language',
          navScanner: 'Scanner',
          navInventory: 'Inventory',
          navSales: 'Sales log',
          navPurchases: 'Purchase log',
          navStatement: 'Gold statement',
          heroTitle: 'Sales log',
          heroSubtitle:
            'Review every sold piece, who sold it, and for how much. Filter the log by sale date to audit a specific day.',
          filtersSectionAria: 'Sales filters',
          filterLabel: 'Filter by sold date',
          quickFiltersAria: 'Quick sold date filters',
          filterToday: 'Today',
          filterYesterday: 'Yesterday',
          filterWeek: 'This week',
          filterClear: 'Clear',
          statsLoading: 'Loading sales…',
          statsNoSales: 'No sales recorded yet.',
          statsNoMatches: 'No sales match the selected filter{description}.',
          statsSummarySingular: 'Showing {visible} of {total} sold item{filter}.',
          statsSummaryPlural: 'Showing {visible} of {total} sold items{filter}.',
          statsFilterSuffix: ' for {description}',
          loadingMessage: 'Loading sales history…',
          errorGeneric: 'Unable to load sales history.',
          errorStats: 'Unable to load sales.',
          emptyState: 'No sales recorded yet.',
          tableSku: 'SKU',
          tablePiece: 'Piece',
          tablePhoto: 'Photo',
          tableWeight: 'Weight (g)',
          tableKarat: 'Karat',
          tableStatus: 'Status',
          tableSoldPrice: 'Sold price',
          tableSoldDate: 'Sold date',
          tableSoldBy: 'Sold by',
          tableNotes: 'Notes',
          photoViewerCaption: 'Sold piece photo',
          photoViewerStatusLoading: 'Loading photo…',
          photoViewerStatusUnavailable: 'Photo unavailable.',
          photoViewerClose: 'Close photo',
          photoDefaultLabel: 'Sold piece',
          photoViewerAlt: '{label} photo',
          photoViewerOpen: 'View photo of {label}',
          statusSold: 'Sold',
          statusRecorded: 'Recorded',
          filterDescriptionToday: 'Today ({date})',
          filterDescriptionYesterday: 'Yesterday ({date})',
          filterDescriptionExact: '{date}',
          filterDescriptionWeek: 'This week ({range})',
          filterRange: '{start} – {end}'
        },
        ar: {
          pageTitle: 'Veridian Atelier • سجل المبيعات',
          languageLabel: 'اللغة',
          languageSelectAria: 'اختيار اللغة',
          navScanner: 'الماسح',
          navInventory: 'المخزون',
          navSales: 'سجل المبيعات',
          navPurchases: 'سجل المشتريات',
          navStatement: 'بيان الذهب',
          heroTitle: 'سجل المبيعات',
          heroSubtitle:
            'راجع كل قطعة تم بيعها، ومن باعها، ومبلغ البيع. قم بتصفية السجل بتاريخ البيع لمراجعة يوم محدد.',
          filtersSectionAria: 'مرشحات المبيعات',
          filterLabel: 'تصفية حسب تاريخ البيع',
          quickFiltersAria: 'مرشحات سريعة لتاريخ البيع',
          filterToday: 'اليوم',
          filterYesterday: 'أمس',
          filterWeek: 'هذا الأسبوع',
          filterClear: 'مسح',
          statsLoading: 'جاري تحميل المبيعات…',
          statsNoSales: 'لم يتم تسجيل أي مبيعات بعد.',
          statsNoMatches: 'لا توجد مبيعات مطابقة لمرشح البحث المحدد{description}.',
          statsSummarySingular: 'عرض {visible} من أصل {total} قطعة مباعة{filter}.',
          statsSummaryPlural: 'عرض {visible} من أصل {total} قطع مباعة{filter}.',
          statsFilterSuffix: ' لـ{description}',
          loadingMessage: 'جاري تحميل سجل المبيعات…',
          errorGeneric: 'تعذر تحميل سجل المبيعات.',
          errorStats: 'تعذر تحميل بيانات المبيعات.',
          emptyState: 'لم يتم تسجيل أي مبيعات بعد.',
          tableSku: 'رمز الصنف',
          tablePiece: 'القطعة',
          tablePhoto: 'الصورة',
          tableWeight: 'الوزن (غرام)',
          tableKarat: 'العيار',
          tableStatus: 'الحالة',
          tableSoldPrice: 'سعر البيع',
          tableSoldDate: 'تاريخ البيع',
          tableSoldBy: 'اسم البائع',
          tableNotes: 'ملاحظات',
          photoViewerCaption: 'صورة القطعة المباعة',
          photoViewerStatusLoading: 'جاري تحميل الصورة…',
          photoViewerStatusUnavailable: 'الصورة غير متاحة.',
          photoViewerClose: 'إغلاق الصورة',
          photoDefaultLabel: 'قطعة مباعة',
          photoViewerAlt: 'صورة {label}',
          photoViewerOpen: 'عرض صورة {label}',
          statusSold: 'مباع',
          statusRecorded: 'مسجل',
          filterDescriptionToday: 'اليوم ({date})',
          filterDescriptionYesterday: 'أمس ({date})',
          filterDescriptionExact: '{date}',
          filterDescriptionWeek: 'هذا الأسبوع ({range})',
          filterRange: '{start} – {end}'
        }
      };

      let currentLanguage = localStorage.getItem('statementLanguage') === 'ar' ? 'ar' : 'en';
      let isLoading = false;
      const renderState = {
        total: 0,
        visible: 0,
        description: '',
        emptyReason: 'none'
      };

      const DRIVE_PATTERNS = [
        /[?&]id=([A-Za-z0-9_-]+)/i,
        /\/file\/d\/([A-Za-z0-9_-]+)/i,
        /\/uc\?export=(?:download|view)&id=([A-Za-z0-9_-]+)/i,
        /\/open\?id=([A-Za-z0-9_-]+)/i,
        /\/thumbnail\?id=([A-Za-z0-9_-]+)/i,
        /\/d\/([A-Za-z0-9_-]+)/i
      ];

      function t(key, replacements) {
        const langTable = translations[currentLanguage] || translations.en;
        const template = key in langTable ? langTable[key] : translations.en[key] || key;
        if (!replacements) return template;
        return template.replace(/\{(\w+)\}/g, (match, token) => {
          if (Object.prototype.hasOwnProperty.call(replacements, token)) {
            return replacements[token];
          }
          return match;
        });
      }

      function getLocale() {
        return currentLanguage === 'ar' ? 'ar-EG' : undefined;
      }

      function formatNumber(value) {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) return String(value ?? '');
        const locale = getLocale();
        return numeric.toLocaleString(locale);
      }

      function updateLanguageAttributes() {
        document.documentElement.lang = currentLanguage === 'ar' ? 'ar' : 'en';
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        document.body.classList.toggle('rtl', currentLanguage === 'ar');
      }

      function renderStaticText() {
        document.title = t('pageTitle');
        i18nElements.forEach((element) => {
          if (!(element instanceof HTMLElement)) return;
          if (element.hasAttribute('data-i18n-dynamic')) return;
          const key = element.getAttribute('data-i18n');
          if (!key) return;
          element.textContent = t(key);
        });

        if (languageToggle) {
          languageToggle.value = currentLanguage;
          languageToggle.setAttribute('aria-label', t('languageSelectAria'));
        }

        if (filtersSection) {
          filtersSection.setAttribute('aria-label', t('filtersSectionAria'));
        }

        if (tableSection) {
          tableSection.setAttribute('aria-label', t('navSales'));
        }

        if (quickFiltersGroup) {
          quickFiltersGroup.setAttribute('aria-label', t('quickFiltersAria'));
        }

        if (photoViewerClose) {
          photoViewerClose.setAttribute('aria-label', t('photoViewerClose'));
        }

        if (photoViewerCaption && photoViewerCaption.hasAttribute('data-i18n')) {
          photoViewerCaption.textContent = t('photoViewerCaption');
        }
      }

      function updateLoadingDisplay() {
        if (loadingEl) {
          loadingEl.textContent = t('loadingMessage');
        }
      }

      function updateEmptyDisplay() {
        if (!emptyEl) return;
        if (renderState.emptyReason === 'no-sales') {
          emptyEl.textContent = t('emptyState');
        } else if (renderState.emptyReason === 'no-matches') {
          const description = renderState.description ? ` (${renderState.description})` : '';
          emptyEl.textContent = t('statsNoMatches', { description });
        }
      }

      function updateStatsDisplay() {
        if (!statsEl) return;
        if (isLoading) {
          statsEl.textContent = t('statsLoading');
          return;
        }
        if (renderState.emptyReason === 'error') {
          statsEl.textContent = t('errorStats');
          return;
        }
        if (renderState.emptyReason === 'no-sales') {
          statsEl.textContent = t('statsNoSales');
          return;
        }
        const filterSuffix = renderState.description
          ? t('statsFilterSuffix', { description: renderState.description })
          : '';
        const summaryKey = renderState.total === 1 ? 'statsSummarySingular' : 'statsSummaryPlural';
        statsEl.textContent = t(summaryKey, {
          visible: formatNumber(renderState.visible),
          total: formatNumber(renderState.total),
          filter: filterSuffix
        });
      }

      function updatePhotoViewerDefaults() {
        if (photoViewerCaption && photoViewerCaption.hasAttribute('data-i18n') && photoViewer?.hidden !== false) {
          photoViewerCaption.textContent = t('photoViewerCaption');
        }
        if (photoViewerStatus && photoViewerStatus.hasAttribute('data-i18n')) {
          const statusState = photoViewerStatus.dataset.state || 'loading';
          if (statusState === 'error') {
            photoViewerStatus.textContent = t('photoViewerStatusUnavailable');
          } else {
            photoViewerStatus.textContent = t('photoViewerStatusLoading');
          }
        }
      }

      function refreshLanguageDependentText() {
        renderStaticText();
        updateLanguageAttributes();
        updateLoadingDisplay();
        updateEmptyDisplay();
        updateStatsDisplay();
        updatePhotoViewerDefaults();
      }

      function applyLanguage(language) {
        const nextLanguage = translations[language] ? language : 'en';
        if (currentLanguage === nextLanguage) {
          refreshLanguageDependentText();
          applyFilter();
          return;
        }
        currentLanguage = nextLanguage;
        localStorage.setItem('statementLanguage', currentLanguage);
        refreshLanguageDependentText();
        applyFilter();
      }

      let soldItems = [];
      let activeDateFilter = '';
      let activeRangeFilter = null;
      let activeQuickFilter = '';
      let activePhotoTrigger = null;
      let previousFocusElement = null;
      let photoViewerUrls = [];
      let photoViewerUrlIndex = 0;

      function getDriveId(url = '') {
        const value = String(url || '').trim();
        if (!value) return null;
        for (const pattern of DRIVE_PATTERNS) {
          const match = value.match(pattern);
          if (match && match[1]) {
            return match[1];
          }
        }
        return null;
      }

      function resolvePhotoSources(rawValue) {
        const value = String(rawValue ?? '').trim();
        if (!value || value === '—' || /^no\s+photo/i.test(value) || /^n\/?a$/i.test(value)) return null;

        const driveId = getDriveId(value);
        if (!driveId) {
          return {
            thumb: [value],
            full: [value]
          };
        }

        const thumbCandidates = [
          `https://drive.google.com/thumbnail?id=${driveId}&sz=s400`,
          `https://lh3.googleusercontent.com/d/${driveId}=s400`,
          `https://drive.google.com/uc?export=view&id=${driveId}`,
          value
        ];

        const fullCandidates = [
          `https://drive.google.com/uc?export=view&id=${driveId}`,
          `https://lh3.googleusercontent.com/d/${driveId}=s1600`,
          `https://drive.google.com/thumbnail?id=${driveId}&sz=s1600`,
          value
        ];

        return {
          thumb: Array.from(new Set(thumbCandidates.filter(Boolean))),
          full: Array.from(new Set(fullCandidates.filter(Boolean)))
        };
      }

      function openPhotoViewer(urls = [], label = t('photoViewerCaption'), trigger = null) {
        if (!photoViewer || !photoViewerImage) return;
        const candidates = Array.isArray(urls)
          ? Array.from(new Set(urls.filter(Boolean)))
          : [];
        if (!candidates.length) return;

        previousFocusElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        activePhotoTrigger = trigger instanceof HTMLElement ? trigger : null;
        photoViewerUrls = candidates;
        photoViewerUrlIndex = 0;

        const captionText = label && String(label).trim() ? String(label).trim() : t('photoViewerCaption');
        if (photoViewerCaption) {
          photoViewerCaption.textContent = captionText;
          photoViewerCaption.hidden = false;
        }
        if (photoViewerStatus) {
          photoViewerStatus.textContent = t('photoViewerStatusLoading');
          photoViewerStatus.dataset.state = 'loading';
          photoViewerStatus.hidden = false;
        }

        photoViewerImage.hidden = true;
        photoViewerImage.alt = t('photoViewerAlt', { label: captionText });
        photoViewerImage.removeAttribute('src');
        photoViewerImage.onload = () => {
          if (photoViewerStatus) photoViewerStatus.hidden = true;
          photoViewerImage.hidden = false;
          photoViewerImage.onload = null;
          photoViewerImage.onerror = null;
        };
        photoViewerImage.onerror = () => {
          photoViewerUrlIndex += 1;
          if (photoViewerUrlIndex < photoViewerUrls.length) {
            photoViewerImage.src = photoViewerUrls[photoViewerUrlIndex];
          } else {
            if (photoViewerStatus) {
              photoViewerStatus.textContent = t('photoViewerStatusUnavailable');
              photoViewerStatus.dataset.state = 'error';
              photoViewerStatus.hidden = false;
            }
            photoViewerImage.hidden = true;
            photoViewerImage.onload = null;
            photoViewerImage.onerror = null;
            photoViewerImage.removeAttribute('src');
          }
        };

        document.body.classList.add('photo-viewer-open');
        photoViewer.hidden = false;
        photoViewerImage.src = photoViewerUrls[photoViewerUrlIndex];
        photoViewerClose?.focus({ preventScroll: true });
      }

      function closePhotoViewer() {
        if (!photoViewer || photoViewer.hidden) return;
        photoViewer.hidden = true;
        document.body.classList.remove('photo-viewer-open');

        if (photoViewerImage) {
          photoViewerImage.onload = null;
          photoViewerImage.onerror = null;
          photoViewerImage.removeAttribute('src');
          photoViewerImage.hidden = true;
        }
        if (photoViewerStatus) {
          photoViewerStatus.textContent = t('photoViewerStatusLoading');
          photoViewerStatus.dataset.state = 'loading';
          photoViewerStatus.hidden = true;
        }
        if (photoViewerCaption) {
          photoViewerCaption.textContent = t('photoViewerCaption');
          photoViewerCaption.hidden = false;
        }

        photoViewerUrls = [];
        photoViewerUrlIndex = 0;

        const focusTarget = activePhotoTrigger || previousFocusElement;
        if (focusTarget && typeof focusTarget.focus === 'function' && document.contains(focusTarget)) {
          focusTarget.focus({ preventScroll: true });
        }
        activePhotoTrigger = null;
        previousFocusElement = null;
      }

      photoViewerClose?.addEventListener('click', closePhotoViewer);
      photoViewerBackdrop?.addEventListener('click', closePhotoViewer);
      photoViewer?.addEventListener('click', (event) => {
        if (event.target?.dataset?.close === 'photoViewer') {
          closePhotoViewer();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !photoViewer?.hidden) {
          event.preventDefault();
          closePhotoViewer();
        }
      });

      function setLoading(state) {
        isLoading = Boolean(state);
        if (loadingEl) loadingEl.hidden = !state;
        if (state) {
          tableWrapper.hidden = true;
          if (emptyEl) emptyEl.hidden = true;
          if (errorEl) errorEl.hidden = true;
        }
        updateLoadingDisplay();
        updateStatsDisplay();
      }

      function normalizeRowKeys(row) {
        const out = {};
        let laborFeeRaw;
        let profitFeeRaw;

        for (const k of Object.keys(row)) {
          const value = row[k];
          const keyLower = k.toLowerCase();

          out[k] = value;
          out[keyLower.trim()] = value;

          if (keyLower.includes('sku')) out['sku'] = value;
          if (keyLower.includes('timestamp')) out['timestamp'] = value;
          if (keyLower.includes('type')) out['type'] = value;
          if (keyLower.includes('status') || keyLower.includes('حالة')) out['availability'] = value;
          if (keyLower.includes('piece type') || keyLower.includes('نوع القطعة')) out['name'] = value;
          if (keyLower.includes('weight') || keyLower.includes('وزن')) out['weight'] = value;
          if (keyLower.includes('karat') || keyLower.includes('carat') || keyLower.includes('عيار')) out['karat'] = value;
          if (keyLower.includes('making fee') || keyLower.includes('أجور')) out['fees'] = value;
          if (keyLower.includes('اجور بالغرام')) laborFeeRaw = value;
          if (keyLower.includes('ربح لكل غرام')) profitFeeRaw = value;
          if (keyLower.includes('description') || keyLower.includes('وصف')) out['description'] = value;
          if (keyLower.includes('photo') || keyLower.includes('video')) out['photo'] = value;
          if (keyLower.includes('أسم البائع')) out['soldby'] = value;
          if (keyLower.includes('تاريخ المبيع')) out['solddate'] = value;
          if (
            keyLower.includes('مبلغ البيع') ||
            keyLower.includes('sold price') ||
            keyLower.includes('sell price') ||
            keyLower.includes('sale price') ||
            keyLower.includes('sold amount') ||
            keyLower.includes('sale amount')
          ) {
            out['soldprice'] = value;
          }
          if (keyLower.includes('ملاحظات')) out['notes'] = value;
        }

        const hasLaborFee = typeof laborFeeRaw !== 'undefined' && String(laborFeeRaw ?? '').trim() !== '';
        const hasProfitFee = typeof profitFeeRaw !== 'undefined' && String(profitFeeRaw ?? '').trim() !== '';

        if (hasLaborFee || hasProfitFee) {
          const parseFeeComponent = (raw) => {
            const normalized = String(raw ?? '').trim();
            if (!normalized) return 0;
            const numeric = Number(normalized.replace(/[^0-9.,-]/g, '').replace(',', '.'));
            return Number.isFinite(numeric) ? numeric : 0;
          };

          const laborFee = parseFeeComponent(laborFeeRaw);
          const profitFee = parseFeeComponent(profitFeeRaw);
          const totalFees = laborFee + profitFee;

          if (Number.isFinite(totalFees)) {
            const formattedTotal = totalFees
              .toFixed(4)
              .replace(/\.0+$/, '')
              .replace(/(\.\d*?)0+$/, '$1');
            out['fees'] = formattedTotal;
          }
        }

        return out;
      }

      function parseSheetDate(value) {
        if (value === null || value === undefined || value === '') return null;
        if (value instanceof Date && !Number.isNaN(value.valueOf())) return value;
        if (typeof value === 'number' && Number.isFinite(value)) {
          const excelEpoch = Date.UTC(1899, 11, 30);
          return new Date(excelEpoch + value * 86400000);
        }

        const normalized = String(value).trim();
        if (!normalized) return null;

        const isoMatch = normalized.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (isoMatch) {
          const year = Number(isoMatch[1]);
          const month = Number(isoMatch[2]);
          const day = Number(isoMatch[3]);
          const isoDate = new Date(year, month - 1, day);
          if (!Number.isNaN(isoDate.valueOf())) return isoDate;
        }

        const slashMatch = normalized.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
        if (slashMatch) {
          let first = Number(slashMatch[1]);
          let second = Number(slashMatch[2]);
          let year = Number(slashMatch[3]);
          if (year < 100) year += 2000;
          let month = first;
          let day = second;
          if (first > 12 && second <= 12) {
            day = first;
            month = second;
          } else if (second > 12 && first <= 12) {
            month = first;
            day = second;
          }
          const altDate = new Date(year, month - 1, day);
          if (!Number.isNaN(altDate.valueOf())) return altDate;
        }

        const parsed = new Date(normalized);
        return Number.isNaN(parsed.valueOf()) ? null : parsed;
      }

      function dateToInputValue(date) {
        if (!(date instanceof Date) || Number.isNaN(date.valueOf())) return null;
        const tzOffset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - tzOffset).toISOString().slice(0, 10);
      }

      function formatFilterLabel(value) {
        if (!value) return '';
        const date = new Date(`${value}T00:00:00`);
        if (Number.isNaN(date.valueOf())) return value;
        const locale = getLocale();
        return date.toLocaleDateString(locale, DATE_FORMAT);
      }

      function formatRangeLabel(startValue, endValue) {
        const startLabel = formatFilterLabel(startValue);
        const endLabel = formatFilterLabel(endValue);
        if (!startLabel || !endLabel) return '';
        if (startLabel === endLabel) return startLabel;
        return t('filterRange', { start: startLabel, end: endLabel });
      }

      function getActiveFilterDescription() {
        if (activeRangeFilter && activeRangeFilter.start && activeRangeFilter.end) {
          const rangeLabel = formatRangeLabel(activeRangeFilter.start, activeRangeFilter.end);
          if (!rangeLabel) return '';
          if (activeRangeFilter.type === 'week') {
            return t('filterDescriptionWeek', { range: rangeLabel });
          }
          return rangeLabel;
        }
        if (activeDateFilter) {
          const baseLabel = formatFilterLabel(activeDateFilter);
          if (!baseLabel) return '';
          if (activeQuickFilter === 'today') return t('filterDescriptionToday', { date: baseLabel });
          if (activeQuickFilter === 'yesterday') return t('filterDescriptionYesterday', { date: baseLabel });
          return t('filterDescriptionExact', { date: baseLabel });
        }
        return '';
      }

      function updateQuickFilterState() {
        if (!quickFilterButtons || typeof quickFilterButtons.forEach !== 'function') return;
        quickFilterButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          if (button.dataset.quickFilter === activeQuickFilter) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });
      }

      function setQuickFilter(type) {
        if (!type) return;
        if (!['today', 'yesterday', 'week'].includes(type)) return;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let nextDateFilter = '';
        let nextRangeFilter = null;
        let nextQuickFilter = type;

        if (type === 'today') {
          nextDateFilter = dateToInputValue(today) || '';
        } else if (type === 'yesterday') {
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          nextDateFilter = dateToInputValue(yesterday) || '';
        } else if (type === 'week') {
          const start = new Date(today);
          const dayOfWeek = start.getDay();
          start.setDate(start.getDate() - dayOfWeek);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          const startValue = dateToInputValue(start);
          const endValue = dateToInputValue(end);
          if (startValue && endValue) {
            nextRangeFilter = {
              type: 'week',
              start: startValue,
              end: endValue
            };
            nextDateFilter = '';
          } else {
            nextQuickFilter = '';
          }
        }

        if (!nextDateFilter && !nextRangeFilter) {
          nextQuickFilter = '';
        }

        activeQuickFilter = nextQuickFilter;
        activeRangeFilter = nextRangeFilter;
        activeDateFilter = nextRangeFilter ? '' : nextDateFilter;

        if (dateFilter) {
          dateFilter.value = activeDateFilter;
        }

        updateQuickFilterState();
        applyFilter();
      }

      function clearFilters() {
        activeDateFilter = '';
        activeRangeFilter = null;
        activeQuickFilter = '';
        if (dateFilter) dateFilter.value = '';
        updateQuickFilterState();
      }

      function buildSoldItems(rows) {
        const items = [];
        for (const row of rows) {
          const availabilityRaw = row['availability'] ?? row['status|الحالة'] ?? row['status'] ?? '';
          const availability = String(availabilityRaw ?? '').trim();
          const soldFlag = availability ? /^no|sold|مباع|غير متوفر/i.test(availability) : false;

          const soldDateRaw = row['solddate'] ?? row['sale date'] ?? row['sold date'] ?? row['تاريخ المبيع'] ?? '';
          const soldPriceRaw = row['soldprice'] ?? row['sale price'] ?? row['sell price'] ?? row['مبلغ البيع'] ?? '';
          const soldByRaw = row['soldby'] ?? row['أسم البائع'] ?? '';
          const notesRaw = row['notes'] ?? row['ملاحظات'] ?? '';

          const hasDetails = [soldDateRaw, soldPriceRaw, soldByRaw, notesRaw].some((val) => String(val ?? '').trim());
          if (!soldFlag && !hasDetails) continue;

          const soldDateObj = parseSheetDate(soldDateRaw);
          const filterKey = soldDateObj ? dateToInputValue(soldDateObj) : null;

          const sku = String(row['sku'] ?? '').trim();
          const pieceName = String(row['name'] ?? row['description'] ?? '').trim();
          const weight = String(row['weight'] ?? '').trim();
          const karat = String(row['karat'] ?? '').trim();
          const soldPrice = String(soldPriceRaw ?? '').trim();
          const soldBy = String(soldByRaw ?? '').trim();
          const notes = String(notesRaw ?? '').trim();
          const photoSources = resolvePhotoSources(row['photo']);
          const viewerLabel = pieceName || sku || '';

          items.push({
            sku,
            name: pieceName,
            weight,
            karat,
            soldPrice,
            soldBy,
            notes,
            filterKey,
            sortDate: soldDateObj ? soldDateObj.getTime() : null,
            soldFlag,
            photoSources,
            viewerLabel,
            soldDate: soldDateObj,
            soldDateRaw: String(soldDateRaw ?? '').trim()
          });
        }
        return items;
      }

      function getCellValue(value) {
        return value && String(value).trim() ? String(value).trim() : '—';
      }

      function formatSoldDate(item) {
        if (item.soldDate instanceof Date && !Number.isNaN(item.soldDate.valueOf())) {
          const locale = getLocale();
          return item.soldDate.toLocaleDateString(locale, DATE_FORMAT);
        }
        if (item.soldDateRaw && String(item.soldDateRaw).trim()) {
          return String(item.soldDateRaw).trim();
        }
        return '—';
      }

      function render(items) {
        tableBody.innerHTML = '';
        const activeLabel = getActiveFilterDescription();
        renderState.total = soldItems.length;
        renderState.visible = items.length;
        renderState.description = activeLabel;

        if (!items.length) {
          tableWrapper.hidden = true;
          renderState.emptyReason = soldItems.length ? 'no-matches' : 'no-sales';
          if (emptyEl) {
            emptyEl.hidden = isLoading;
            if (!isLoading) {
              updateEmptyDisplay();
            }
          }
          updateStatsDisplay();
          return;
        }

        tableWrapper.hidden = false;
        if (emptyEl) emptyEl.hidden = true;
        renderState.emptyReason = 'none';

        for (const item of items) {
          const tr = document.createElement('tr');
          const columns = [
            { labelKey: 'tableSku', value: getCellValue(item.sku) },
            { labelKey: 'tablePiece', value: getCellValue(item.name) },
            { labelKey: 'tablePhoto', key: 'photo', className: 'photo-cell' },
            { labelKey: 'tableWeight', value: getCellValue(item.weight) },
            { labelKey: 'tableKarat', value: getCellValue(item.karat) },
            { labelKey: 'tableStatus', key: 'status' },
            { labelKey: 'tableSoldPrice', value: getCellValue(item.soldPrice) },
            { labelKey: 'tableSoldDate', value: formatSoldDate(item) },
            { labelKey: 'tableSoldBy', value: getCellValue(item.soldBy) },
            { labelKey: 'tableNotes', value: getCellValue(item.notes), className: 'notes-cell' }
          ];

          for (const column of columns) {
            const td = document.createElement('td');
            const labelText = column.labelKey ? t(column.labelKey) : '';
            if (labelText) td.dataset.label = labelText;
            if (column.className) td.classList.add(column.className);

            if (column.key === 'status') {
              const badge = document.createElement('span');
              badge.className = `status-pill ${item.soldFlag ? 'status-sold' : 'status-recorded'}`;
              badge.textContent = t(item.soldFlag ? 'statusSold' : 'statusRecorded');
              td.appendChild(badge);
            } else if (column.key === 'photo') {
              let thumbCandidates = item.photoSources?.thumb
                ? Array.from(new Set(item.photoSources.thumb.filter(Boolean)))
                : [];
              const fullCandidates = item.photoSources?.full
                ? Array.from(new Set(item.photoSources.full.filter(Boolean)))
                : [];

              if (!thumbCandidates.length && fullCandidates.length) {
                thumbCandidates = [...fullCandidates];
              }

              if (!thumbCandidates.length || !fullCandidates.length) {
                td.textContent = '—';
              } else {
                const baseLabel = item.viewerLabel || item.name || item.sku || t('photoDefaultLabel');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'photo-thumb loading';
                const openLabel = t('photoViewerOpen', { label: baseLabel });
                button.setAttribute('aria-label', openLabel);
                button.setAttribute('aria-haspopup', 'dialog');
                button.title = openLabel;

                const thumbImg = document.createElement('img');
                thumbImg.alt = t('photoViewerAlt', { label: baseLabel });
                thumbImg.decoding = 'async';
                thumbImg.loading = 'lazy';
                button.appendChild(thumbImg);
                td.appendChild(button);

                const handleClick = () => openPhotoViewer(fullCandidates, baseLabel, button);
                button.addEventListener('click', handleClick);

                let thumbIndex = 0;
                const onThumbError = () => {
                  if (thumbIndex >= thumbCandidates.length) {
                    thumbImg.removeEventListener('error', onThumbError);
                    button.removeEventListener('click', handleClick);
                    button.remove();
                    td.textContent = '—';
                    return;
                  }
                  thumbImg.src = thumbCandidates[thumbIndex];
                  thumbIndex += 1;
                };

                thumbImg.addEventListener('load', () => {
                  button.classList.remove('loading');
                  thumbImg.removeEventListener('error', onThumbError);
                }, { once: true });
                thumbImg.addEventListener('error', onThumbError);

                thumbImg.src = thumbCandidates[thumbIndex];
                thumbIndex += 1;
              }
            } else {
              td.textContent = getCellValue(column.value);
            }

            tr.appendChild(td);
          }

          tableBody.appendChild(tr);
        }
        updateStatsDisplay();
      }

      function applyFilter() {
        let filtered = soldItems;
        if (activeRangeFilter) {
          filtered = filtered.filter((item) => {
            if (!item.filterKey) return false;
            return item.filterKey >= activeRangeFilter.start && item.filterKey <= activeRangeFilter.end;
          });
        } else if (activeDateFilter) {
          filtered = filtered.filter((item) => item.filterKey === activeDateFilter);
        }
        render(filtered);
      }

      async function loadSales() {
        setLoading(true);
        try {
          const response = await fetch(SALES_ENDPOINT, { credentials: 'include' });
          if (response.status === 401) {
            window.handleUnauthorized?.();
            return;
          }
          if (!response.ok) {
            throw new Error(`Failed to load sales (${response.status})`);
          }

          const payload = await response.json();
          const rows = Array.isArray(payload)
            ? payload
            : (Array.isArray(payload?.rows) ? payload.rows : []);
          const normalizedRows = rows.map(normalizeRowKeys);
          soldItems = buildSoldItems(normalizedRows);
          soldItems.sort((a, b) => {
            if (a.sortDate && b.sortDate) return b.sortDate - a.sortDate;
            if (a.sortDate) return -1;
            if (b.sortDate) return 1;
            return a.sku.localeCompare(b.sku);
          });
          applyFilter();
        } catch (error) {
          console.error('Failed to load sales log:', error);
          if (errorEl) {
            errorEl.textContent = error?.message || t('errorGeneric');
            errorEl.hidden = false;
          }
          tableWrapper.hidden = true;
          if (emptyEl) emptyEl.hidden = true;
          renderState.total = 0;
          renderState.visible = 0;
          renderState.description = '';
          renderState.emptyReason = 'error';
        } finally {
          setLoading(false);
        }
      }

      dateFilter?.addEventListener('change', (event) => {
        const value = event?.target?.value || '';
        activeDateFilter = value;
        activeRangeFilter = null;
        activeQuickFilter = '';
        updateQuickFilterState();
        applyFilter();
      });

      clearBtn?.addEventListener('click', () => {
        clearFilters();
        applyFilter();
        dateFilter?.focus();
      });

      if (quickFilterButtons && typeof quickFilterButtons.forEach === 'function') {
        quickFilterButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          button.addEventListener('click', () => {
            const type = button.dataset.quickFilter;
            setQuickFilter(type);
          });
        });
      }

      if (languageToggle) {
        languageToggle.addEventListener('change', (event) => {
          applyLanguage(event?.target?.value);
        });
      }

      updateQuickFilterState();
      setLoading(true);
      refreshLanguageDependentText();
      loadSales();
    })();
  </script>
</body>
</html>
