<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veridian Atelier • Sales Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="../assets/logo-website-test.jpg">
  <link rel="apple-touch-icon" href="../assets/logo-website-test.jpg">
  <link rel="manifest" href="../manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2596be">
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://api.gold-api.com; child-src 'self' https://drive.google.com https://*.googleusercontent.com; frame-src 'self' https://drive.google.com https://*.googleusercontent.com; object-src 'none'; base-uri 'self'; frame-ancestors 'self'"
  >
  <script>if (sessionStorage.getItem('authenticated') !== 'true') { window.location.replace('../index.html'); }</script>
  <style>
    :root {
      --pad: 18px;
      --gold-primary: #2596be;
      --gold-secondary: #2596be;
      --gold-dark: #1f7fa0;
      --gold-light: #e6f6fb;
      --ivory: #fafdff;
      --charcoal: #1f2a30;
      --warm-gray: #4f6b78;
      --accent-gold: #2596be;
      --bg: radial-gradient(circle at 10% 0%, rgba(37, 150, 190, 0.15) 0%, rgba(37, 150, 190, 0.05) 55%, #ffffff 100%);
      --glass: rgba(255, 255, 255, 0.92);
      --card-border: rgba(37, 150, 190, 0.3);
      --accent: var(--gold-primary);
      --accent-dark: var(--gold-dark);
      --text: var(--charcoal);
      --muted: var(--warm-gray);
      --shadow: 0 18px 40px -24px rgba(37, 150, 190, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: calc(var(--pad) * 1.2) var(--pad) calc(var(--pad) * 1.6);
    }
    body.photo-viewer-open { overflow: hidden; }
    .page {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .brand-logo {
      height: 56px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 6px 16px rgba(37, 150, 190, 0.25));
    }
    .page-nav {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(229, 246, 251, 0.78));
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: 0 18px 32px -22px rgba(37, 150, 190, 0.45);
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x proximity;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      backdrop-filter: blur(12px);
    }
    .page-nav::-webkit-scrollbar { display: none; }
    .nav-link {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--accent-dark);
      text-decoration: none;
      transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      background: rgba(255, 255, 255, 0.82);
      scroll-snap-align: center;
      min-width: max-content;
      box-shadow: inset 0 0 0 1px rgba(37, 150, 190, 0.12);
    }
    .nav-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.45);
    }
    .nav-link:focus-visible {
      outline: 2px solid rgba(37, 150, 190, 0.55);
      outline-offset: 2px;
    }
    .nav-link:active {
      transform: scale(0.98);
    }
    .nav-link.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      box-shadow: 0 14px 30px -18px rgba(37, 150, 190, 0.6);
    }
    .hero-title {
      margin: 0;
      font-family: 'Playfair Display', 'Times New Roman', serif;
      font-size: clamp(1.6rem, 3.8vw, 2.4rem);
      letter-spacing: 0.02em;
      color: var(--text);
    }
    .hero-subtitle {
      margin: 0;
      font-size: clamp(0.95rem, 2vw, 1.05rem);
      color: var(--muted);
      max-width: 620px;
    }
    .glass-card {
      background: var(--glass);
      border: 1px solid var(--card-border);
      border-radius: 28px;
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .filter-card {
      display: grid;
      gap: 14px;
    }
    .filter-form {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    .filter-input-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-filters {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-filter-btn {
      background: rgba(255, 255, 255, 0.92);
      color: var(--accent-dark);
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: none;
    }
    .quick-filter-btn:hover {
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.35);
    }
    .quick-filter-btn.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      border-color: transparent;
      box-shadow: 0 14px 30px -20px rgba(37, 150, 190, 0.55);
    }
    .filter-form label {
      font-weight: 600;
      font-size: 0.95rem;
      font-family: 'Playfair Display', serif;
    }
    .filter-form input[type="date"] {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(37, 150, 190, 0.25);
      background: rgba(255, 255, 255, 0.95);
      font-size: 0.98rem;
      font-family: inherit;
      color: var(--text);
    }
    button {
      padding: 10px 16px;
      border-radius: 14px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      border: none;
      box-shadow: 0 14px 32px -18px rgba(37, 150, 190, 0.45);
      transition: transform 150ms ease, box-shadow 150ms ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px -18px rgba(37, 150, 190, 0.55);
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: none;
      background: rgba(37, 150, 190, 0.35);
    }
    .clear-btn {
      background: rgba(255, 255, 255, 0.92);
      color: var(--accent-dark);
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: none;
    }
    .clear-btn:hover {
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.35);
    }
    .sales-stats {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .table-card {
      display: grid;
      gap: 18px;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid rgba(37, 150, 190, 0.2);
      background: rgba(255, 255, 255, 0.75);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 880px;
    }
    thead {
      background: rgba(37, 150, 190, 0.1);
    }
    th, td {
      text-align: left;
      padding: 14px;
      border-bottom: 1px solid rgba(37, 150, 190, 0.18);
      font-size: 0.95rem;
    }
    th {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      font-weight: 600;
    }
    tbody tr:hover {
      background: rgba(255, 255, 255, 0.6);
    }
    .notes-cell {
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 320px;
    }
    .photo-cell { width: 110px; }
    .photo-thumb {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 68px;
      height: 68px;
      padding: 0;
      appearance: none;
      border: 1px solid rgba(37, 150, 190, 0.35);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 12px 24px -18px rgba(44, 44, 44, 0.35);
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.2s ease;
    }
    .photo-thumb.loading img { opacity: 0; }
    .photo-thumb.loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(37, 150, 190, 0.45);
      border-top-color: transparent;
      animation: photo-spin 0.8s linear infinite;
    }
    .photo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 14px;
      transition: opacity 0.2s ease;
    }
    .photo-thumb:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 28px -20px rgba(44, 44, 44, 0.4);
    }
    .photo-thumb:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .photo-thumb--empty {
      cursor: default;
      background: rgba(255, 255, 255, 0.65);
      box-shadow: none;
      border-style: dashed;
    }
    .photo-thumb--empty span {
      font-size: 0.72rem;
      color: var(--muted);
      padding: 0 6px;
      text-align: center;
    }
    .photo-thumb--empty:hover { transform: none; }
    @keyframes photo-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .photo-viewer {
      position: fixed;
      inset: 0;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .photo-viewer[hidden] { display: none; }
    .photo-viewer__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(44, 44, 44, 0.45);
      backdrop-filter: blur(4px);
    }
    .photo-viewer__content {
      position: relative;
      z-index: 1;
      margin: 0;
      display: grid;
      gap: 12px;
      max-width: min(90vw, 520px);
      max-height: 85vh;
      padding: clamp(18px, 4vw, 26px);
      border-radius: 26px;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: 0 28px 64px -24px rgba(0, 0, 0, 0.45);
      text-align: center;
    }
    .photo-viewer__content img {
      width: 100%;
      max-height: 62vh;
      object-fit: contain;
      border-radius: 18px;
      box-shadow: 0 20px 44px -26px rgba(0, 0, 0, 0.4);
    }
    .photo-viewer__close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 50%;
      background: rgba(44, 44, 44, 0.82);
      color: #fff;
      font-size: 1.35rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.18s ease, background 0.2s ease;
    }
    .photo-viewer__close:hover {
      transform: scale(1.05);
      background: rgba(44, 44, 44, 0.94);
    }
    .photo-viewer__close:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .photo-viewer__content figcaption {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
    }
    .photo-viewer__status {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    @media (max-width: 640px) {
      .photo-thumb {
        width: 58px;
        height: 58px;
      }
      .photo-viewer {
        padding: 18px;
      }
      .photo-viewer__content {
        padding: clamp(16px, 6vw, 24px);
        gap: 10px;
      }
      .photo-viewer__close {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
      }
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .status-sold {
      background: rgba(26, 143, 85, 0.12);
      color: #1a8f55;
      border: 1px solid rgba(26, 143, 85, 0.25);
    }
    .status-recorded {
      background: rgba(37, 150, 190, 0.12);
      color: var(--gold-dark);
      border: 1px solid rgba(37, 150, 190, 0.28);
    }
    .loading {
      color: var(--muted);
      font-size: 0.95rem;
    }
    .empty-state {
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
    }
    .error-message {
      color: #d84a63;
      font-weight: 600;
      font-size: 0.95rem;
    }
    @media (max-width: 720px) {
      .header-top { justify-content: center; }
      .page-nav {
        width: 100%;
        justify-content: flex-start;
      }
      .brand-logo { height: 46px; }
      table {
        min-width: 100%;
      }
      th, td {
        padding: 12px;
        font-size: 0.9rem;
      }
      .notes-cell {
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-top">
        <img src="../assets/logo-website-test.jpg" alt="Veridian Atelier logo" class="brand-logo" />
        <nav class="page-nav" aria-label="Workspace navigation">
          <a class="nav-link" href="./index.html">Scanner</a>
          <a class="nav-link" href="./items.html">Inventory</a>
          <a class="nav-link active" href="./sales.html" aria-current="page">Sales log</a>
          <a class="nav-link" href="./purchases.html">Purchase log</a>
          <a class="nav-link" href="./statement.html">Gold statement</a>
        </nav>
      </div>
      <h1 class="hero-title">Sales log</h1>
      <p class="hero-subtitle">Review every sold piece, who sold it, and for how much. Filter the log by sale date to audit a specific day.</p>
    </header>

    <section class="glass-card filter-card" aria-label="Sales filters">
      <form id="filterForm" class="filter-form" novalidate>
        <label for="soldDateFilter">Filter by sold date</label>
        <div class="filter-input-group">
          <input type="date" id="soldDateFilter" name="soldDate" />
          <div class="quick-filters" role="group" aria-label="Quick sold date filters">
            <button type="button" class="quick-filter-btn" data-quick-filter="today">Today</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="yesterday">Yesterday</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="week">This week</button>
          </div>
        </div>
        <button type="button" id="clearFilterBtn" class="clear-btn">Clear</button>
      </form>
      <p id="salesStats" class="sales-stats">Loading sales…</p>
    </section>

    <section class="glass-card table-card" aria-label="Sales log">
      <div id="salesLoading" class="loading" role="status">Loading sales history…</div>
      <div id="salesError" class="error-message" hidden role="alert"></div>
      <p id="salesEmpty" class="empty-state" hidden>No sales recorded yet.</p>
      <div id="salesTableWrapper" class="table-wrapper" hidden>
        <table class="sales-table">
          <thead>
            <tr>
              <th scope="col">SKU</th>
              <th scope="col">Piece</th>
              <th scope="col">Photo</th>
              <th scope="col">Weight (g)</th>
              <th scope="col">Karat</th>
              <th scope="col">Status</th>
              <th scope="col">Sold price</th>
              <th scope="col">Sold date</th>
              <th scope="col">Sold by</th>
              <th scope="col">Notes</th>
            </tr>
          </thead>
          <tbody id="salesTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div
    id="photoViewer"
    class="photo-viewer"
    hidden
    role="dialog"
    aria-modal="true"
    aria-labelledby="photoViewerCaption"
    tabindex="-1"
  >
    <div id="photoViewerBackdrop" class="photo-viewer__backdrop" data-close="photoViewer"></div>
    <figure class="photo-viewer__content">
      <button
        type="button"
        id="photoViewerClose"
        class="photo-viewer__close"
        aria-label="Close photo"
        data-close="photoViewer"
      >&times;</button>
      <img id="photoViewerImage" alt="" decoding="async" hidden />
      <figcaption id="photoViewerCaption">Sold piece photo</figcaption>
      <p id="photoViewerStatus" class="photo-viewer__status" hidden>Loading photo…</p>
    </figure>
  </div>

  <script>
    (function () {
      const DATE_FORMAT = { year: 'numeric', month: 'short', day: 'numeric' };
      const DEFAULT_CONFIG = {
        authEndpoint: '/api/auth',
        inventoryEndpoint: '/api/inventory',
        salesEndpoint: '/api/sales',
        whatsappNumber: '393481651384',
        goldPriceUrl: 'https://api.gold-api.com/price/XAU'
      };

      const APP_CONFIG = Object.freeze({
        ...DEFAULT_CONFIG,
        ...(window.APP_CONFIG && typeof window.APP_CONFIG === 'object' ? window.APP_CONFIG : {})
      });

      const INVENTORY_ENDPOINT = APP_CONFIG.inventoryEndpoint;

      const statsEl = document.getElementById('salesStats');
      const tableBody = document.getElementById('salesTableBody');
      const tableWrapper = document.getElementById('salesTableWrapper');
      const emptyEl = document.getElementById('salesEmpty');
      const loadingEl = document.getElementById('salesLoading');
      const errorEl = document.getElementById('salesError');
      const dateFilter = document.getElementById('soldDateFilter');
      const clearBtn = document.getElementById('clearFilterBtn');
      const quickFilterButtons = document.querySelectorAll('[data-quick-filter]');
      const photoViewer = document.getElementById('photoViewer');
      const photoViewerImage = document.getElementById('photoViewerImage');
      const photoViewerCaption = document.getElementById('photoViewerCaption');
      const photoViewerStatus = document.getElementById('photoViewerStatus');
      const photoViewerClose = document.getElementById('photoViewerClose');
      const photoViewerBackdrop = document.getElementById('photoViewerBackdrop');

      const DRIVE_PATTERNS = [
        /[?&]id=([A-Za-z0-9_-]+)/i,
        /\/file\/d\/([A-Za-z0-9_-]+)/i,
        /\/uc\?export=(?:download|view)&id=([A-Za-z0-9_-]+)/i,
        /\/open\?id=([A-Za-z0-9_-]+)/i,
        /\/thumbnail\?id=([A-Za-z0-9_-]+)/i,
        /\/d\/([A-Za-z0-9_-]+)/i
      ];

      let soldItems = [];
      let activeDateFilter = '';
      let activeRangeFilter = null;
      let activeQuickFilter = '';
      let activePhotoTrigger = null;
      let previousFocusElement = null;
      let photoViewerUrls = [];
      let photoViewerUrlIndex = 0;

      function getDriveId(url = '') {
        const value = String(url || '').trim();
        if (!value) return null;
        for (const pattern of DRIVE_PATTERNS) {
          const match = value.match(pattern);
          if (match && match[1]) {
            return match[1];
          }
        }
        return null;
      }

      function resolvePhotoSources(rawValue) {
        const value = String(rawValue ?? '').trim();
        if (!value || value === '—' || /^no\s+photo/i.test(value) || /^n\/?a$/i.test(value)) return null;

        const driveId = getDriveId(value);
        if (!driveId) {
          return {
            thumb: [value],
            full: [value]
          };
        }

        const thumbCandidates = [
          `https://drive.google.com/thumbnail?id=${driveId}&sz=s400`,
          `https://lh3.googleusercontent.com/d/${driveId}=s400`,
          `https://drive.google.com/uc?export=view&id=${driveId}`,
          value
        ];

        const fullCandidates = [
          `https://drive.google.com/uc?export=view&id=${driveId}`,
          `https://lh3.googleusercontent.com/d/${driveId}=s1600`,
          `https://drive.google.com/thumbnail?id=${driveId}&sz=s1600`,
          value
        ];

        return {
          thumb: Array.from(new Set(thumbCandidates.filter(Boolean))),
          full: Array.from(new Set(fullCandidates.filter(Boolean)))
        };
      }

      function openPhotoViewer(urls = [], label = 'Sold piece photo', trigger = null) {
        if (!photoViewer || !photoViewerImage) return;
        const candidates = Array.isArray(urls)
          ? Array.from(new Set(urls.filter(Boolean)))
          : [];
        if (!candidates.length) return;

        previousFocusElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
        activePhotoTrigger = trigger instanceof HTMLElement ? trigger : null;
        photoViewerUrls = candidates;
        photoViewerUrlIndex = 0;

        const captionText = label && String(label).trim() ? String(label).trim() : 'Sold piece photo';
        if (photoViewerCaption) {
          photoViewerCaption.textContent = captionText;
          photoViewerCaption.hidden = false;
        }
        if (photoViewerStatus) {
          photoViewerStatus.textContent = 'Loading photo…';
          photoViewerStatus.hidden = false;
        }

        photoViewerImage.hidden = true;
        photoViewerImage.alt = captionText;
        photoViewerImage.removeAttribute('src');
        photoViewerImage.onload = () => {
          if (photoViewerStatus) photoViewerStatus.hidden = true;
          photoViewerImage.hidden = false;
          photoViewerImage.onload = null;
          photoViewerImage.onerror = null;
        };
        photoViewerImage.onerror = () => {
          photoViewerUrlIndex += 1;
          if (photoViewerUrlIndex < photoViewerUrls.length) {
            photoViewerImage.src = photoViewerUrls[photoViewerUrlIndex];
          } else {
            if (photoViewerStatus) {
              photoViewerStatus.textContent = 'Photo unavailable.';
              photoViewerStatus.hidden = false;
            }
            photoViewerImage.hidden = true;
            photoViewerImage.onload = null;
            photoViewerImage.onerror = null;
            photoViewerImage.removeAttribute('src');
          }
        };

        document.body.classList.add('photo-viewer-open');
        photoViewer.hidden = false;
        photoViewerImage.src = photoViewerUrls[photoViewerUrlIndex];
        photoViewerClose?.focus({ preventScroll: true });
      }

      function closePhotoViewer() {
        if (!photoViewer || photoViewer.hidden) return;
        photoViewer.hidden = true;
        document.body.classList.remove('photo-viewer-open');

        if (photoViewerImage) {
          photoViewerImage.onload = null;
          photoViewerImage.onerror = null;
          photoViewerImage.removeAttribute('src');
          photoViewerImage.hidden = true;
        }
        if (photoViewerStatus) {
          photoViewerStatus.textContent = 'Loading photo…';
          photoViewerStatus.hidden = true;
        }
        if (photoViewerCaption) {
          photoViewerCaption.textContent = 'Sold piece photo';
          photoViewerCaption.hidden = false;
        }

        photoViewerUrls = [];
        photoViewerUrlIndex = 0;

        const focusTarget = activePhotoTrigger || previousFocusElement;
        if (focusTarget && typeof focusTarget.focus === 'function' && document.contains(focusTarget)) {
          focusTarget.focus({ preventScroll: true });
        }
        activePhotoTrigger = null;
        previousFocusElement = null;
      }

      photoViewerClose?.addEventListener('click', closePhotoViewer);
      photoViewerBackdrop?.addEventListener('click', closePhotoViewer);
      photoViewer?.addEventListener('click', (event) => {
        if (event.target?.dataset?.close === 'photoViewer') {
          closePhotoViewer();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !photoViewer?.hidden) {
          event.preventDefault();
          closePhotoViewer();
        }
      });

      function setLoading(state) {
        if (loadingEl) loadingEl.hidden = !state;
        if (state) {
          tableWrapper.hidden = true;
          emptyEl.hidden = true;
          if (errorEl) errorEl.hidden = true;
          statsEl.textContent = 'Loading sales…';
        }
      }

      function normalizeRowKeys(row) {
        const out = {};
        let laborFeeRaw;
        let profitFeeRaw;

        for (const k of Object.keys(row)) {
          const value = row[k];
          const keyLower = k.toLowerCase();

          out[k] = value;
          out[keyLower.trim()] = value;

          if (keyLower.includes('sku')) out['sku'] = value;
          if (keyLower.includes('timestamp')) out['timestamp'] = value;
          if (keyLower.includes('type')) out['type'] = value;
          if (keyLower.includes('status') || keyLower.includes('حالة')) out['availability'] = value;
          if (keyLower.includes('piece type') || keyLower.includes('نوع القطعة')) out['name'] = value;
          if (keyLower.includes('weight') || keyLower.includes('وزن')) out['weight'] = value;
          if (keyLower.includes('karat') || keyLower.includes('carat') || keyLower.includes('عيار')) out['karat'] = value;
          if (keyLower.includes('making fee') || keyLower.includes('أجور')) out['fees'] = value;
          if (keyLower.includes('اجور بالغرام')) laborFeeRaw = value;
          if (keyLower.includes('ربح لكل غرام')) profitFeeRaw = value;
          if (keyLower.includes('description') || keyLower.includes('وصف')) out['description'] = value;
          if (keyLower.includes('photo') || keyLower.includes('video')) out['photo'] = value;
          if (keyLower.includes('أسم البائع')) out['soldby'] = value;
          if (keyLower.includes('تاريخ المبيع')) out['solddate'] = value;
          if (
            keyLower.includes('مبلغ البيع') ||
            keyLower.includes('sold price') ||
            keyLower.includes('sell price') ||
            keyLower.includes('sale price') ||
            keyLower.includes('sold amount') ||
            keyLower.includes('sale amount')
          ) {
            out['soldprice'] = value;
          }
          if (keyLower.includes('ملاحظات')) out['notes'] = value;
        }

        const hasLaborFee = typeof laborFeeRaw !== 'undefined' && String(laborFeeRaw ?? '').trim() !== '';
        const hasProfitFee = typeof profitFeeRaw !== 'undefined' && String(profitFeeRaw ?? '').trim() !== '';

        if (hasLaborFee || hasProfitFee) {
          const parseFeeComponent = (raw) => {
            const normalized = String(raw ?? '').trim();
            if (!normalized) return 0;
            const numeric = Number(normalized.replace(/[^0-9.,-]/g, '').replace(',', '.'));
            return Number.isFinite(numeric) ? numeric : 0;
          };

          const laborFee = parseFeeComponent(laborFeeRaw);
          const profitFee = parseFeeComponent(profitFeeRaw);
          const totalFees = laborFee + profitFee;

          if (Number.isFinite(totalFees)) {
            const formattedTotal = totalFees
              .toFixed(4)
              .replace(/\.0+$/, '')
              .replace(/(\.\d*?)0+$/, '$1');
            out['fees'] = formattedTotal;
          }
        }

        return out;
      }

      function parseSheetDate(value) {
        if (value === null || value === undefined || value === '') return null;
        if (value instanceof Date && !Number.isNaN(value.valueOf())) return value;
        if (typeof value === 'number' && Number.isFinite(value)) {
          const excelEpoch = Date.UTC(1899, 11, 30);
          return new Date(excelEpoch + value * 86400000);
        }

        const normalized = String(value).trim();
        if (!normalized) return null;

        const isoMatch = normalized.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (isoMatch) {
          const year = Number(isoMatch[1]);
          const month = Number(isoMatch[2]);
          const day = Number(isoMatch[3]);
          const isoDate = new Date(year, month - 1, day);
          if (!Number.isNaN(isoDate.valueOf())) return isoDate;
        }

        const slashMatch = normalized.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/);
        if (slashMatch) {
          let first = Number(slashMatch[1]);
          let second = Number(slashMatch[2]);
          let year = Number(slashMatch[3]);
          if (year < 100) year += 2000;
          let month = first;
          let day = second;
          if (first > 12 && second <= 12) {
            day = first;
            month = second;
          } else if (second > 12 && first <= 12) {
            month = first;
            day = second;
          }
          const altDate = new Date(year, month - 1, day);
          if (!Number.isNaN(altDate.valueOf())) return altDate;
        }

        const parsed = new Date(normalized);
        return Number.isNaN(parsed.valueOf()) ? null : parsed;
      }

      function dateToInputValue(date) {
        if (!(date instanceof Date) || Number.isNaN(date.valueOf())) return null;
        const tzOffset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - tzOffset).toISOString().slice(0, 10);
      }

      function formatFilterLabel(value) {
        if (!value) return '';
        const date = new Date(`${value}T00:00:00`);
        if (Number.isNaN(date.valueOf())) return value;
        return date.toLocaleDateString(undefined, DATE_FORMAT);
      }

      function getActiveFilterDescription() {
        if (activeRangeFilter && activeRangeFilter.label) {
          return activeRangeFilter.label;
        }
        if (activeDateFilter) {
          const baseLabel = formatFilterLabel(activeDateFilter);
          if (!baseLabel) return '';
          if (activeQuickFilter === 'today') return `Today (${baseLabel})`;
          if (activeQuickFilter === 'yesterday') return `Yesterday (${baseLabel})`;
          return baseLabel;
        }
        return '';
      }

      function updateQuickFilterState() {
        if (!quickFilterButtons || typeof quickFilterButtons.forEach !== 'function') return;
        quickFilterButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          if (button.dataset.quickFilter === activeQuickFilter) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });
      }

      function setQuickFilter(type) {
        if (!type) return;
        if (!['today', 'yesterday', 'week'].includes(type)) return;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let nextDateFilter = '';
        let nextRangeFilter = null;
        let nextQuickFilter = type;

        if (type === 'today') {
          nextDateFilter = dateToInputValue(today) || '';
        } else if (type === 'yesterday') {
          const yesterday = new Date(today);
          yesterday.setDate(yesterday.getDate() - 1);
          nextDateFilter = dateToInputValue(yesterday) || '';
        } else if (type === 'week') {
          const start = new Date(today);
          const dayOfWeek = start.getDay();
          start.setDate(start.getDate() - dayOfWeek);
          const end = new Date(start);
          end.setDate(start.getDate() + 6);
          const startValue = dateToInputValue(start);
          const endValue = dateToInputValue(end);
          if (startValue && endValue) {
            const startLabel = start.toLocaleDateString(undefined, DATE_FORMAT);
            const endLabel = end.toLocaleDateString(undefined, DATE_FORMAT);
            const rangeLabel = startLabel === endLabel ? startLabel : `${startLabel} – ${endLabel}`;
            nextRangeFilter = {
              type: 'week',
              start: startValue,
              end: endValue,
              label: `This week (${rangeLabel})`
            };
            nextDateFilter = '';
          } else {
            nextQuickFilter = '';
          }
        }

        if (!nextDateFilter && !nextRangeFilter) {
          nextQuickFilter = '';
        }

        activeQuickFilter = nextQuickFilter;
        activeRangeFilter = nextRangeFilter;
        activeDateFilter = nextRangeFilter ? '' : nextDateFilter;

        if (dateFilter) {
          dateFilter.value = activeDateFilter;
        }

        updateQuickFilterState();
        applyFilter();
      }

      function clearFilters() {
        activeDateFilter = '';
        activeRangeFilter = null;
        activeQuickFilter = '';
        if (dateFilter) dateFilter.value = '';
        updateQuickFilterState();
      }

      function buildSoldItems(rows) {
        const items = [];
        for (const row of rows) {
          const availabilityRaw = row['availability'] ?? row['status|الحالة'] ?? row['status'] ?? '';
          const availability = String(availabilityRaw ?? '').trim();
          const soldFlag = availability ? /^no|sold|مباع|غير متوفر/i.test(availability) : false;

          const soldDateRaw = row['solddate'] ?? row['sale date'] ?? row['sold date'] ?? row['تاريخ المبيع'] ?? '';
          const soldPriceRaw = row['soldprice'] ?? row['sale price'] ?? row['sell price'] ?? row['مبلغ البيع'] ?? '';
          const soldByRaw = row['soldby'] ?? row['أسم البائع'] ?? '';
          const notesRaw = row['notes'] ?? row['ملاحظات'] ?? '';

          const hasDetails = [soldDateRaw, soldPriceRaw, soldByRaw, notesRaw].some((val) => String(val ?? '').trim());
          if (!soldFlag && !hasDetails) continue;

          const soldDateObj = parseSheetDate(soldDateRaw);
          const filterKey = soldDateObj ? dateToInputValue(soldDateObj) : null;
          const displayDate = soldDateObj
            ? soldDateObj.toLocaleDateString(undefined, DATE_FORMAT)
            : (String(soldDateRaw ?? '').trim() || '—');

          const sku = String(row['sku'] ?? '').trim();
          const pieceName = String(row['name'] ?? row['description'] ?? '').trim();
          const weight = String(row['weight'] ?? '').trim();
          const karat = String(row['karat'] ?? '').trim();
          const soldPrice = String(soldPriceRaw ?? '').trim();
          const soldBy = String(soldByRaw ?? '').trim();
          const notes = String(notesRaw ?? '').trim();
          const photoSources = resolvePhotoSources(row['photo']);
          const viewerLabel = pieceName || sku || 'Sold piece';

          items.push({
            sku: sku || '—',
            name: pieceName || '—',
            weight: weight || '—',
            karat: karat || '—',
            soldPrice: soldPrice || '—',
            soldBy: soldBy || '—',
            notes: notes || '—',
            displayDate: displayDate || '—',
            filterKey,
            sortDate: soldDateObj ? soldDateObj.getTime() : null,
            soldFlag,
            photoSources,
            viewerLabel
          });
        }
        return items;
      }

      function render(items) {
        tableBody.innerHTML = '';
        if (!items.length) {
          tableWrapper.hidden = true;
          emptyEl.hidden = false;
          const activeLabel = getActiveFilterDescription();
          emptyEl.textContent = soldItems.length
            ? `No sales match the selected filter${activeLabel ? ` (${activeLabel})` : ''}.`
            : 'No sales recorded yet.';
          statsEl.textContent = soldItems.length
            ? `Showing 0 of ${soldItems.length} sold items${activeLabel ? ` for ${activeLabel}` : ''}.`
            : 'No sold items recorded yet.';
          return;
        }

        tableWrapper.hidden = false;
        emptyEl.hidden = true;

        for (const item of items) {
          const tr = document.createElement('tr');
          const columns = [
            { label: 'SKU', value: item.sku },
            { label: 'Piece', value: item.name },
            { label: 'Photo', key: 'photo', className: 'photo-cell' },
            { label: 'Weight (g)', value: item.weight },
            { label: 'Karat', value: item.karat },
            { label: 'Status', key: 'status' },
            { label: 'Sold price', value: item.soldPrice },
            { label: 'Sold date', value: item.displayDate },
            { label: 'Sold by', value: item.soldBy },
            { label: 'Notes', value: item.notes, className: 'notes-cell' }
          ];

          for (const column of columns) {
            const td = document.createElement('td');
            td.dataset.label = column.label;
            if (column.className) td.classList.add(column.className);

            if (column.key === 'status') {
              const badge = document.createElement('span');
              badge.className = `status-pill ${item.soldFlag ? 'status-sold' : 'status-recorded'}`;
              badge.textContent = item.soldFlag ? 'Sold' : 'Recorded';
              td.appendChild(badge);
            } else if (column.key === 'photo') {
              let thumbCandidates = item.photoSources?.thumb
                ? Array.from(new Set(item.photoSources.thumb.filter(Boolean)))
                : [];
              const fullCandidates = item.photoSources?.full
                ? Array.from(new Set(item.photoSources.full.filter(Boolean)))
                : [];

              if (!thumbCandidates.length && fullCandidates.length) {
                thumbCandidates = [...fullCandidates];
              }

              if (!thumbCandidates.length || !fullCandidates.length) {
                td.textContent = '—';
              } else {
                const labelText = item.viewerLabel || item.name || item.sku || 'Sold piece';
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'photo-thumb loading';
                button.setAttribute('aria-label', `View photo of ${labelText}`);
                button.setAttribute('aria-haspopup', 'dialog');
                button.title = `View photo of ${labelText}`;

                const thumbImg = document.createElement('img');
                thumbImg.alt = `${labelText} photo`;
                thumbImg.decoding = 'async';
                thumbImg.loading = 'lazy';
                button.appendChild(thumbImg);
                td.appendChild(button);

                const handleClick = () => openPhotoViewer(fullCandidates, labelText, button);
                button.addEventListener('click', handleClick);

                let thumbIndex = 0;
                const onThumbError = () => {
                  if (thumbIndex >= thumbCandidates.length) {
                    thumbImg.removeEventListener('error', onThumbError);
                    button.removeEventListener('click', handleClick);
                    button.remove();
                    td.textContent = '—';
                    return;
                  }
                  thumbImg.src = thumbCandidates[thumbIndex];
                  thumbIndex += 1;
                };

                thumbImg.addEventListener('load', () => {
                  button.classList.remove('loading');
                  thumbImg.removeEventListener('error', onThumbError);
                }, { once: true });
                thumbImg.addEventListener('error', onThumbError);

                thumbImg.src = thumbCandidates[thumbIndex];
                thumbIndex += 1;
              }
            } else {
              td.textContent = column.value || '—';
            }

            tr.appendChild(td);
          }

          tableBody.appendChild(tr);
        }

        const total = soldItems.length;
        const activeLabel = getActiveFilterDescription();
        const activeText = activeLabel ? ` for ${activeLabel}` : '';
        statsEl.textContent = `Showing ${items.length} of ${total} sold item${total === 1 ? '' : 's'}${activeText}.`;
      }

      function applyFilter() {
        let filtered = soldItems;
        if (activeRangeFilter) {
          filtered = filtered.filter((item) => {
            if (!item.filterKey) return false;
            return item.filterKey >= activeRangeFilter.start && item.filterKey <= activeRangeFilter.end;
          });
        } else if (activeDateFilter) {
          filtered = filtered.filter((item) => item.filterKey === activeDateFilter);
        }
        render(filtered);
      }

      async function loadSales() {
        setLoading(true);
        try {
          const response = await fetch(INVENTORY_ENDPOINT, { credentials: 'include' });
          if (response.status === 401) {
            sessionStorage.removeItem('authenticated');
            window.location.replace('../index.html');
            return;
          }
          if (!response.ok) {
            throw new Error(`Failed to load sales (${response.status})`);
          }

          const payload = await response.json();
          const rows = Array.isArray(payload)
            ? payload
            : (Array.isArray(payload?.rows) ? payload.rows : []);
          const normalizedRows = rows.map(normalizeRowKeys);
          soldItems = buildSoldItems(normalizedRows);
          soldItems.sort((a, b) => {
            if (a.sortDate && b.sortDate) return b.sortDate - a.sortDate;
            if (a.sortDate) return -1;
            if (b.sortDate) return 1;
            return a.sku.localeCompare(b.sku);
          });
          applyFilter();
        } catch (error) {
          console.error('Failed to load sales log:', error);
          if (errorEl) {
            errorEl.textContent = error?.message || 'Unable to load sales history.';
            errorEl.hidden = false;
          }
          tableWrapper.hidden = true;
          emptyEl.hidden = true;
          statsEl.textContent = 'Unable to load sales.';
        } finally {
          setLoading(false);
        }
      }

      dateFilter?.addEventListener('change', (event) => {
        const value = event?.target?.value || '';
        activeDateFilter = value;
        activeRangeFilter = null;
        activeQuickFilter = '';
        updateQuickFilterState();
        applyFilter();
      });

      clearBtn?.addEventListener('click', () => {
        clearFilters();
        applyFilter();
        dateFilter?.focus();
      });

      if (quickFilterButtons && typeof quickFilterButtons.forEach === 'function') {
        quickFilterButtons.forEach((button) => {
          if (!(button instanceof HTMLElement)) return;
          button.addEventListener('click', () => {
            const type = button.dataset.quickFilter;
            setQuickFilter(type);
          });
        });
      }

      updateQuickFilterState();
      loadSales();
    })();
  </script>
</body>
</html>
