<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veridian Atelier • Gold Inventory Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="../assets/logo-website-test.jpg">
  <link rel="apple-touch-icon" href="../assets/logo-website-test.jpg">
  <link rel="manifest" href="../manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2596be">
  <script>
    window.__redirectToLogin = function redirectToLogin() {
      window.location.replace('../index.html');
    };

    window.handleUnauthorized = async function handleUnauthorized() {
      try {
        await fetch('../api/logout', { method: 'POST', credentials: 'include' });
      } catch (error) {
        console.warn('Failed to notify logout.', error);
      }
      window.__redirectToLogin();
    };

    (async () => {
      try {
        const response = await fetch('../api/session', { credentials: 'include' });
        if (!response.ok) {
          throw new Error('Session invalid');
        }
        const data = await response.json();
        if (!data?.authenticated) {
          throw new Error('Unauthenticated');
        }
      } catch (error) {
        window.__redirectToLogin();
      }
    })();
  </script>
  <link rel="stylesheet" href="./workspace-nav.css">
  <style>
    :root {
      --pad: 18px;
      --gold-primary: #2596be;
      --gold-secondary: #2596be;
      --gold-dark: #1f7fa0;
      --gold-light: #e6f6fb;
      --ivory: #fafdff;
      --charcoal: #1f2a30;
      --warm-gray: #4f6b78;
      --accent-gold: #2596be;
      --bg: radial-gradient(circle at 10% 0%, rgba(37, 150, 190, 0.15) 0%, rgba(37, 150, 190, 0.05) 55%, #ffffff 100%);
      --glass: rgba(255, 255, 255, 0.92);
      --card-border: rgba(37, 150, 190, 0.3);
      --accent: var(--gold-primary);
      --accent-dark: var(--gold-dark);
      --text: var(--charcoal);
      --muted: var(--warm-gray);
      --shadow: 0 18px 40px -24px rgba(37, 150, 190, 0.35);
    }

    html {
      scroll-behavior: smooth;
    }

    * {
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: calc(var(--pad) * 1.2) var(--pad) calc(var(--pad) * 1.6);
    }

    .page {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .refresh-button--panel {
      margin: 20px auto;
      border-radius: 14px;
      padding: 12px 20px;
      box-shadow: 0 14px 32px -18px rgba(37, 150, 190, 0.45);
    }

    .last-updated {
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 10px;
    }

    body.rtl {
      direction: rtl;
      font-family: 'Amiri', 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
    }
body.rtl .data-row {
      flex-direction: row-reverse;
    }

    body.rtl .data-label {
      text-align: right;
    }

    body.rtl .data-value {
      text-align: left;
    }

    @media (max-width: 720px) {
      .stats-grid { grid-template-columns: 1fr; }
      .data-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
      .highlight-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page" id="dashboardPage">
    <header>
      <div class="header-top">
        <img src="../assets/logo-website-test.jpg" alt="Veridian Atelier logo" class="brand-logo" />
        <div class="nav-actions">
          <nav class="page-nav" aria-label="Workspace navigation" data-i18n-aria-label="navAria">
            <a class="nav-link" href="./index.html" data-i18n="navScanner">Scanner</a>
            <a class="nav-link" href="./items.html" data-i18n="navInventory">Inventory</a>
            <a class="nav-link" href="./sales.html" data-i18n="navSales">Sales log</a>
            <a class="nav-link" href="./purchases.html" data-i18n="navPurchases">Purchase log</a>
            <a class="nav-link active" href="./statement.html" aria-current="page" data-i18n="navStatement">Gold statement</a>
          </nav>
        </div>
        <div class="language-toggle">
          <label for="languageToggle" class="sr-only" data-i18n="languageLabel">Language</label>
          <div class="language-toggle__panel">
            <select id="languageToggle" aria-label="Select language">
              <option value="en">English</option>
              <option value="ar">العربية</option>
            </select>
            <button
              type="button"
              id="refreshButton"
              class="refresh-button refresh-button--compact"
              aria-label="Refresh statement page"
              data-i18n-aria-label="navRefreshAria"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.36-3.36L23 10"></path>
                <path d="M20.49 15a9 9 0 0 1-14.36 3.36L1 14"></path>
              </svg>
              <span class="sr-only" data-i18n="navRefresh">Refresh</span>
            </button>
          </div>
        </div>
      </div>
      <h1 class="hero-title" data-i18n="heroTitle">Gold Inventory Dashboard</h1>
      <p class="hero-subtitle" data-i18n="heroSubtitle">Real-time overview of gold inventory, sales, purchases, and financial metrics.</p>
    </header>

    <section class="glass-card" aria-label="Gold inventory summary">
      <div class="stats-grid" id="summaryStats">
        <!-- Summary stats will be populated by JavaScript -->
      </div>

      <div class="data-section">
        <h2 class="section-title" data-i18n="sectionInventoryByKarat">Gold Inventory by Karat</h2>
        <div class="data-grid" id="inventoryData">
          <!-- Inventory data will be populated by JavaScript -->
        </div>
      </div>

      <div class="data-section">
        <h2 class="section-title" data-i18n="sectionTransactionsToday">Today's Transactions</h2>
        <div class="data-grid" id="transactionData">
          <!-- Transaction data will be populated by JavaScript -->
        </div>
      </div>

      <div class="highlight-card">
        <h3 class="highlight-title" data-i18n="highlightTitle">Financial Summary</h3>
        <div class="highlight-grid" id="financialData">
          <!-- Financial data will be populated by JavaScript -->
        </div>
      </div>

      <button type="button" class="refresh-button refresh-button--panel" id="refreshData">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6"></path>
          <path d="M1 20v-6h6"></path>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
        </svg>
        <span data-i18n="refreshButton">Refresh Data</span>
      </button>
      <p class="last-updated" id="lastUpdated">Loading latest data…</p>
    </section>
  </div>

  <script>
    (function () {
      'use strict';

      const STATEMENT_ENDPOINT = '/api/statement';

      const summaryStats = document.getElementById('summaryStats');
      const inventoryData = document.getElementById('inventoryData');
      const transactionData = document.getElementById('transactionData');
      const financialData = document.getElementById('financialData');
      const refreshButton = document.getElementById('refreshData');
      const lastUpdated = document.getElementById('lastUpdated');
      const languageToggle = document.getElementById('languageToggle');
      const navRefreshButton = document.getElementById('refreshButton');
      const i18nElements = document.querySelectorAll('[data-i18n]');

      const translations = {
        en: {
          pageTitle: 'Veridian Atelier • Gold Inventory Dashboard',
          languageLabel: 'Language',
          languageSelectAria: 'Select language',
          navScanner: 'Scanner',
          navInventory: 'Inventory',
          navSales: 'Sales log',
          navPurchases: 'Purchase log',
          navStatement: 'Gold statement',
          navRefresh: 'Refresh',
          navRefreshAria: 'Refresh statement page',
          heroTitle: 'Gold Inventory Dashboard',
          heroSubtitle: 'Real-time overview of gold inventory, sales, purchases, and financial metrics.',
          sectionInventoryByKarat: 'Gold Inventory by Karat',
          sectionTransactionsToday: "Today's Transactions",
          highlightTitle: 'Financial Summary',
          refreshButton: 'Refresh Data',
          notAvailable: 'N/A',
          soldLabel: 'sold',
          purchasedLabel: 'purchased',
          summaryTotalGoldInventory: 'Total Gold Inventory',
          summaryTotalGoldInventorySubtitle: 'Across all karats',
          summaryAvailableGold: 'Available Gold',
          summaryAvailableGoldSubtitle: 'Ready for sale',
          summaryTodaySales: "Today's Sales",
          summaryTodaySalesSubtitle: 'Total Revenue',
          summaryTodayPurchases: "Today's Purchases",
          summaryTodayPurchasesSubtitle: 'Total Cost',
          summaryNetProfitToday: 'Net Profit Today',
          summaryNetProfitTodaySubtitle: 'After making fees',
          inventory18kTitle: '18 Karat Gold',
          inventory21kTitle: '21 Karat Gold',
          inventory22kTitle: '22 Karat Gold',
          inventory24kTitle: '24 Karat Gold',
          labelTotalWeight: 'Total Weight',
          labelSoldWeight: 'Sold Weight',
          labelAvailableWeight: 'Available Weight',
          cardTodaySalesTitle: "Today's Sales",
          cardTodayPurchasesTitle: "Today's Purchases",
          templateSold: '{karat} Sold',
          templateRevenue: '{karat} Revenue',
          templatePurchased: '{karat} Purchased',
          templateCost: '{karat} Cost',
          highlightMorningUsdBalance: 'Morning USD Balance',
          highlightMorningLbpBalance: 'Morning LBP Balance',
          highlightTodayTotalMoney: "Today's Total Money",
          highlightLbpToUsdRate: 'LBP to USD Rate',
          highlightTotalAmount18k: 'Total Amount of 18K (كسر)',
          highlightTotalAmount21k: 'Total Amount of 21K (كسر)',
          highlightProfitMonth: 'Profit This Month',
          highlightProfitWeek: 'Profit This Week',
          highlightProfitToday: 'Profit Today',
          currencyUsdPrefix: '$',
          currencyUsdSuffix: '',
          currencyLbp: 'LBP',
          weightUnit: 'g',
          lastUpdatedPrefix: 'Last updated:',
          loadingMessage: 'Loading latest data…',
          errorMessage: 'Error loading data. Please try again.',
          noDataMessage: 'No data available for the statement.'
        },
        ar: {
          pageTitle: 'فيريديان أتيليه • لوحة مراقبة الذهب',
          languageLabel: 'اللغة',
          languageSelectAria: 'اختيار اللغة',
          navScanner: 'الماسح',
          navInventory: 'المخزون',
          navSales: 'سجل المبيعات',
          navPurchases: 'سجل المشتريات',
          navStatement: 'بيان الذهب',
          navRefresh: 'تحديث',
          navRefreshAria: 'تحديث صفحة البيان',
          heroTitle: 'لوحة مراقبة مخزون الذهب',
          heroSubtitle: 'نظرة فورية على المخزون والمبيعات والمشتريات والمؤشرات المالية.',
          sectionInventoryByKarat: 'المخزون حسب العيار',
          sectionTransactionsToday: 'حركات اليوم',
          highlightTitle: 'الملخص المالي',
          refreshButton: 'تحديث البيانات',
          notAvailable: 'غير متوفر',
          soldLabel: 'مباع',
          purchasedLabel: 'مُشترى',
          summaryTotalGoldInventory: 'إجمالي مخزون الذهب',
          summaryTotalGoldInventorySubtitle: 'جميع الأعيرة',
          summaryAvailableGold: 'الذهب المتاح',
          summaryAvailableGoldSubtitle: 'جاهز للبيع',
          summaryTodaySales: 'مبيعات اليوم',
          summaryTodaySalesSubtitle: 'إجمالي الإيرادات',
          summaryTodayPurchases: 'مشتريات اليوم',
          summaryTodayPurchasesSubtitle: 'إجمالي التكاليف',
          summaryNetProfitToday: 'صافي ربح اليوم',
          summaryNetProfitTodaySubtitle: 'بعد المصاريف والخدمات',
          inventory18kTitle: 'ذهب عيار 18',
          inventory21kTitle: 'ذهب عيار 21',
          inventory22kTitle: 'ذهب عيار 22',
          inventory24kTitle: 'ذهب عيار 24',
          labelTotalWeight: 'إجمالي الوزن',
          labelSoldWeight: 'الوزن المبيع',
          labelAvailableWeight: 'الوزن المتاح',
          cardTodaySalesTitle: 'مبيعات اليوم',
          cardTodayPurchasesTitle: 'مشتريات اليوم',
          templateSold: 'الوزن المبيع من {karat}',
          templateRevenue: 'إيرادات {karat}',
          templatePurchased: 'الوزن المشتَرى من {karat}',
          templateCost: 'تكلفة {karat}',
          highlightMorningUsdBalance: 'رصيد الصباح بالدولار',
          highlightMorningLbpBalance: 'رصيد الصباح بالليرة',
          highlightTodayTotalMoney: 'إجمالي السيولة اليوم',
          highlightLbpToUsdRate: 'سعر تحويل الليرة للدولار',
          highlightTotalAmount18k: 'إجمالي قيمة عيار 18 (كسر)',
          highlightTotalAmount21k: 'إجمالي قيمة عيار 21 (كسر)',
          highlightProfitMonth: 'ربح هذا الشهر',
          highlightProfitWeek: 'ربح هذا الأسبوع',
          highlightProfitToday: 'ربح اليوم',
          currencyUsdPrefix: '',
          currencyUsdSuffix: 'دولار أمريكي',
          currencyLbp: 'ل.ل',
          weightUnit: 'غ',
          lastUpdatedPrefix: 'آخر تحديث:',
          loadingMessage: 'جاري تحميل أحدث البيانات…',
          errorMessage: 'حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مجددًا.',
          noDataMessage: 'لا توجد بيانات متاحة لهذا البيان.'
        }
      };

      let currentLanguage = localStorage.getItem('statementLanguage') === 'ar' ? 'ar' : 'en';
      let latestData = null;
      let lastUpdatedTime = null;
      let lastUpdatedStatus = 'loading';

      function t(key) {
        const langTable = translations[currentLanguage] || translations.en;
        if (key in langTable) {
          return langTable[key];
        }
        return translations.en[key] || key;
      }

      function getLocale() {
        return currentLanguage === 'ar' ? 'ar-EG' : undefined;
      }

      function updateLanguageAttributes() {
        document.documentElement.lang = currentLanguage === 'ar' ? 'ar' : 'en';
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        document.body.classList.toggle('rtl', currentLanguage === 'ar');
      }

      function renderStaticText() {
        document.title = t('pageTitle');
        i18nElements.forEach(element => {
          const key = element.getAttribute('data-i18n');
          if (key) {
            element.textContent = t(key);
          }
        });

        if (languageToggle) {
          languageToggle.value = currentLanguage;
          languageToggle.setAttribute('aria-label', t('languageSelectAria'));
        }
      }

      function updateLastUpdatedLabel() {
        if (!lastUpdated) return;

        switch (lastUpdatedStatus) {
          case 'success':
            if (lastUpdatedTime) {
              const locale = getLocale();
              lastUpdated.textContent = `${t('lastUpdatedPrefix')} ${lastUpdatedTime.toLocaleString(locale)}`;
            }
            break;
          case 'error':
            lastUpdated.textContent = t('errorMessage');
            break;
          case 'no-data':
            lastUpdated.textContent = t('noDataMessage');
            break;
          default:
            lastUpdated.textContent = t('loadingMessage');
            break;
        }
      }

      function setLastUpdatedStatus(status, time = null) {
        lastUpdatedStatus = status;
        lastUpdatedTime = time;
        updateLastUpdatedLabel();
      }

      // Format numbers with commas and fixed decimal places
      function formatNumber(value) {
        if (typeof value !== 'number' || isNaN(value)) return t('notAvailable');
        return value.toLocaleString(getLocale(), {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // Format currency values
      function formatCurrency(value) {
        if (typeof value !== 'number' || isNaN(value)) return t('notAvailable');
        const formatted = value.toLocaleString(getLocale(), {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        const prefix = t('currencyUsdPrefix');
        const suffix = t('currencyUsdSuffix');
        if (prefix) {
          return `${prefix}${formatted}`;
        }
        if (suffix) {
          return `${formatted} ${suffix}`;
        }
        return formatted;
      }

      function formatLbp(value) {
        if (typeof value !== 'number' || isNaN(value)) return t('notAvailable');
        return `${formatNumber(value)} ${t('currencyLbp')}`;
      }

      // Format weight values
      function formatWeight(value) {
        if (typeof value !== 'number' || isNaN(value)) return t('notAvailable');
        return `${formatNumber(value)} ${t('weightUnit')}`;
      }

      // Extract numeric value from string
      function extractNumber(value) {
        if (typeof value === 'number') return value;
        if (typeof value !== 'string') return NaN;

        // Remove any non-numeric characters except decimal point and minus sign
        const numericString = value.replace(/[^\d.-]/g, '');
        const num = parseFloat(numericString);
        return isNaN(num) ? NaN : num;
      }

      // Create a stat card
      function createStatCard(title, value, subtitle = '') {
        const card = document.createElement('div');
        card.className = 'stat-card';

        const titleEl = document.createElement('p');
        titleEl.className = 'stat-card__title';
        titleEl.textContent = title;

        const valueEl = document.createElement('p');
        valueEl.className = 'stat-card__value';
        valueEl.textContent = value;

        card.appendChild(titleEl);
        card.appendChild(valueEl);

        if (subtitle) {
          const subtitleEl = document.createElement('p');
          subtitleEl.className = 'stat-card__subtitle';
          subtitleEl.textContent = subtitle;
          card.appendChild(subtitleEl);
        }

        return card;
      }

      // Create a data card
      function createDataCard(icon, title, data) {
        const card = document.createElement('div');
        card.className = 'data-card';

        const header = document.createElement('div');
        header.className = 'data-card__header';

        const iconEl = document.createElement('div');
        iconEl.className = 'data-card__icon';
        iconEl.innerHTML = icon;

        const titleEl = document.createElement('h3');
        titleEl.className = 'data-card__title';
        titleEl.textContent = title;

        header.appendChild(iconEl);
        header.appendChild(titleEl);
        card.appendChild(header);

        const content = document.createElement('div');
        content.className = 'data-card__content';

        data.forEach(item => {
          const row = document.createElement('div');
          row.className = 'data-row';

          const label = document.createElement('span');
          label.className = 'data-label';
          label.textContent = item.label;

          const value = document.createElement('span');
          value.className = 'data-value';
          value.textContent = item.value;

          row.appendChild(label);
          row.appendChild(value);
          content.appendChild(row);
        });

        card.appendChild(content);
        return card;
      }

      // Create a highlight item
      function createHighlightItem(label, value) {
        const item = document.createElement('div');
        item.className = 'highlight-item';

        const labelEl = document.createElement('p');
        labelEl.className = 'highlight-label';
        labelEl.textContent = label;

        const valueEl = document.createElement('p');
        valueEl.className = 'highlight-value';
        valueEl.textContent = value;

        item.appendChild(labelEl);
        item.appendChild(valueEl);
        return item;
      }

      function formatWithKarat(templateKey, karat) {
        return t(templateKey).replace('{karat}', karat);
      }

      // Process and display the data
      function renderData(data) {
        summaryStats.innerHTML = '';
        inventoryData.innerHTML = '';
        transactionData.innerHTML = '';
        financialData.innerHTML = '';

        if (!Array.isArray(data) || !data.length || typeof data[0] !== 'object') {
          return false;
        }

        const row = data[0];

        // Extract and calculate values
        const total18kWeight = extractNumber(row['total 18k gold weight  (gram)']);
        const sold18kWeight = extractNumber(row['sold 18 k gold weight   (gram)']);
        const available18kWeight = extractNumber(row['available 18 k gold weight   (gram)']);

        const total21kWeight = extractNumber(row['total 21k gold weight    (gram)']);
        const sold21kWeight = extractNumber(row['sold 21 k gold weight    (gram)']);
        const available21kWeight = extractNumber(row['available 21 k gold weight   (gram)']);

        const total22kWeight = extractNumber(row['total 22k gold weight    (gram)']);
        const sold22kWeight = extractNumber(row['sold 22 k gold weight    (gram)']);
        const available22kWeight = extractNumber(row['available 22 k gold weight   (gram)']);

        const total24kWeight = extractNumber(row['total 24k gold weight    (gram)']);
        const sold24kWeight = extractNumber(row['sold 24 k gold weight    (gram)']);
        const available24kWeight = extractNumber(row['available 24 k gold weight   (gram)']);

        // Calculate totals
        const totalGoldWeight = total18kWeight + total21kWeight + total22kWeight + total24kWeight;
        const totalAvailableWeight = available18kWeight + available21kWeight + available22kWeight + available24kWeight;

        // Today's transactions
        const todaySold18kWeight = extractNumber(row['today total sold weight of 18 k (gram)']);
        const todaySold18kPrice = extractNumber(row['today total sold price of 18 k ($)']);
        const todaySold21kWeight = extractNumber(row['today total sold weight of 21 k (gram)']);
        const todaySold21kPrice = extractNumber(row['today total sold price of 21 k ($)']);
        const todaySold22kWeight = extractNumber(row['today total sold weight of 22 k (gram)']);
        const todaySold22kPrice = extractNumber(row['today total sold price of 22 k ($)']);
        const todaySold24kWeight = extractNumber(row['today total sold weight of 24 k (gram)']);
        const todaySold24kPrice = extractNumber(row['today total sold price of 24 k ($)']);

        const todayPurchased18kWeight = extractNumber(row['today total purchased weight of 18 k (gram)']);
        const todayPurchased18kAmount = extractNumber(row['today total purchased amount of 18 k ($)']);
        const todayPurchased21kWeight = extractNumber(row['today total purchased weight of 21 k (gram)']);
        const todayPurchased21kAmount = extractNumber(row['today total purchased amount of 21 k ($)']);
        const todayPurchased22kWeight = extractNumber(row['today total purchased weight of 22 k (gram)']);
        const todayPurchased22kAmount = extractNumber(row['today total purchased amount of 22 k ($)']);
        const todayPurchased24kWeight = extractNumber(row['today total purchased weight of 24 k (gram)']);
        const todayPurchased24kAmount = extractNumber(row['today total purchased amount of 24 k ($)']);

        const outOfStoreUSD = extractNumber(row['out of the store today for services $']);
        const outOfStoreLBP = extractNumber(row['out of the store today for services LBP']);
        const liraToDollar = extractNumber(row['money from lira to dollar']);
        const morningUSD = extractNumber(row['money in dollar in the morning ']);
        const morningLBP = extractNumber(row['money in lebanese lira in the morning ']);
        const todayTotalMoney = extractNumber(row['today total money ']);
        const todayDiff18k = extractNumber(row['today total difference amount of 18 k gold']);
        const todayDiff21k = extractNumber(row['today total difference amount of 21 k gold']);
        const profitMonth = extractNumber(row['profit this months']);
        const profitWeek = extractNumber(row['profit this week ']);
        const profitToday = extractNumber(row['profit today ']);

        const todayTotalSoldWeight = todaySold18kWeight + todaySold21kWeight + todaySold22kWeight + todaySold24kWeight;
        const todayTotalSoldPrice = todaySold18kPrice + todaySold21kPrice + todaySold22kPrice + todaySold24kPrice;
        const todayTotalPurchasedWeight = todayPurchased18kWeight + todayPurchased21kWeight + todayPurchased22kWeight + todayPurchased24kWeight;
        const todayTotalPurchasedAmount = todayPurchased18kAmount + todayPurchased21kAmount + todayPurchased22kAmount + todayPurchased24kAmount;

        const soldWeightLabel = `${formatWeight(todayTotalSoldWeight)} ${t('soldLabel')}`;
        const purchasedWeightLabel = `${formatWeight(todayTotalPurchasedWeight)} ${t('purchasedLabel')}`;

        // Summary Stats
        summaryStats.appendChild(createStatCard(
          t('summaryTotalGoldInventory'),
          formatWeight(totalGoldWeight),
          t('summaryTotalGoldInventorySubtitle')
        ));

        summaryStats.appendChild(createStatCard(
          t('summaryAvailableGold'),
          formatWeight(totalAvailableWeight),
          t('summaryAvailableGoldSubtitle')
        ));

        summaryStats.appendChild(createStatCard(
          t('summaryTodaySales'),
          formatCurrency(todayTotalSoldPrice),
          soldWeightLabel
        ));

        summaryStats.appendChild(createStatCard(
          t('summaryTodayPurchases'),
          formatCurrency(todayTotalPurchasedAmount),
          purchasedWeightLabel
        ));

        summaryStats.appendChild(createStatCard(
          t('summaryNetProfitToday'),
          formatCurrency(profitToday),
          t('summaryNetProfitTodaySubtitle')
        ));

        // Inventory Data
        inventoryData.appendChild(createDataCard(
          '18K',
          t('inventory18kTitle'),
          [
            { label: t('labelTotalWeight'), value: formatWeight(total18kWeight) },
            { label: t('labelSoldWeight'), value: formatWeight(sold18kWeight) },
            { label: t('labelAvailableWeight'), value: formatWeight(available18kWeight) }
          ]
        ));

        inventoryData.appendChild(createDataCard(
          '21K',
          t('inventory21kTitle'),
          [
            { label: t('labelTotalWeight'), value: formatWeight(total21kWeight) },
            { label: t('labelSoldWeight'), value: formatWeight(sold21kWeight) },
            { label: t('labelAvailableWeight'), value: formatWeight(available21kWeight) }
          ]
        ));

        inventoryData.appendChild(createDataCard(
          '22K',
          t('inventory22kTitle'),
          [
            { label: t('labelTotalWeight'), value: formatWeight(total22kWeight) },
            { label: t('labelSoldWeight'), value: formatWeight(sold22kWeight) },
            { label: t('labelAvailableWeight'), value: formatWeight(available22kWeight) }
          ]
        ));

        inventoryData.appendChild(createDataCard(
          '24K',
          t('inventory24kTitle'),
          [
            { label: t('labelTotalWeight'), value: formatWeight(total24kWeight) },
            { label: t('labelSoldWeight'), value: formatWeight(sold24kWeight) },
            { label: t('labelAvailableWeight'), value: formatWeight(available24kWeight) }
          ]
        ));

        // Transaction Data
        transactionData.appendChild(createDataCard(
          '💰',
          t('cardTodaySalesTitle'),
          [
            { label: formatWithKarat('templateSold', '18K'), value: formatWeight(todaySold18kWeight) },
            { label: formatWithKarat('templateRevenue', '18K'), value: formatCurrency(todaySold18kPrice) },
            { label: formatWithKarat('templateSold', '21K'), value: formatWeight(todaySold21kWeight) },
            { label: formatWithKarat('templateRevenue', '21K'), value: formatCurrency(todaySold21kPrice) },
            { label: formatWithKarat('templateSold', '22K'), value: formatWeight(todaySold22kWeight) },
            { label: formatWithKarat('templateRevenue', '22K'), value: formatCurrency(todaySold22kPrice) },
            { label: formatWithKarat('templateSold', '24K'), value: formatWeight(todaySold24kWeight) },
            { label: formatWithKarat('templateRevenue', '24K'), value: formatCurrency(todaySold24kPrice) }
          ]
        ));

        transactionData.appendChild(createDataCard(
          '🛒',
          t('cardTodayPurchasesTitle'),
          [
            { label: formatWithKarat('templatePurchased', '18K'), value: formatWeight(todayPurchased18kWeight) },
            { label: formatWithKarat('templateCost', '18K'), value: formatCurrency(todayPurchased18kAmount) },
            { label: formatWithKarat('templatePurchased', '21K'), value: formatWeight(todayPurchased21kWeight) },
            { label: formatWithKarat('templateCost', '21K'), value: formatCurrency(todayPurchased21kAmount) },
            { label: formatWithKarat('templatePurchased', '22K'), value: formatWeight(todayPurchased22kWeight) },
            { label: formatWithKarat('templateCost', '22K'), value: formatCurrency(todayPurchased22kAmount) },
            { label: formatWithKarat('templatePurchased', '24K'), value: formatWeight(todayPurchased24kWeight) },
            { label: formatWithKarat('templateCost', '24K'), value: formatCurrency(todayPurchased24kAmount) }
          ]
        ));

        // Financial Data
        financialData.appendChild(createHighlightItem(
          t('highlightMorningUsdBalance'),
          formatCurrency(morningUSD)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightMorningLbpBalance'),
          formatLbp(morningLBP)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightTodayTotalMoney'),
          formatCurrency(todayTotalMoney)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightLbpToUsdRate'),
          formatNumber(liraToDollar)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightTotalAmount18k'),
          formatWeight(todayDiff18k)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightTotalAmount21k'),
          formatWeight(todayDiff21k)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightProfitMonth'),
          formatCurrency(profitMonth)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightProfitWeek'),
          formatCurrency(profitWeek)
        ));

        financialData.appendChild(createHighlightItem(
          t('highlightProfitToday'),
          formatCurrency(profitToday)
        ));

        return true;
      }

      function applyLanguage(language) {
        currentLanguage = translations[language] ? language : 'en';
        localStorage.setItem('statementLanguage', currentLanguage);
        updateLanguageAttributes();
        renderStaticText();

        if (latestData) {
          renderData(latestData);
        }

        updateLastUpdatedLabel();
      }

      // Fetch data from the secure statement API
      async function fetchData() {
        try {
          if (refreshButton) refreshButton.disabled = true;
          setLastUpdatedStatus('loading');

          const response = await fetch(STATEMENT_ENDPOINT, { credentials: 'include' });

          if (response.status === 401) {
            window.handleUnauthorized?.();
            return;
          }

          if (!response.ok) {
            throw new Error(`Failed to fetch data: ${response.status}`);
          }

          const data = await response.json();
          const hasData = renderData(data);

          if (hasData) {
            latestData = data;
            setLastUpdatedStatus('success', new Date());
          } else {
            latestData = null;
            setLastUpdatedStatus('no-data');
          }
        } catch (error) {
          console.error('Error fetching data:', error);
          setLastUpdatedStatus('error');
        } finally {
          if (refreshButton) refreshButton.disabled = false;
        }
      }

      // Initialize the page
      function initialize() {
        updateLanguageAttributes();
        renderStaticText();
        updateLastUpdatedLabel();
        fetchData();

        if (refreshButton) {
          refreshButton.addEventListener('click', fetchData);
        }

        if (languageToggle) {
          languageToggle.addEventListener('change', event => {
            applyLanguage(event.target.value);
          });
        }

        if (navRefreshButton) {
          navRefreshButton.addEventListener('click', () => {
            window.location.reload();
          });
        }

        // Auto-refresh every 5 minutes
        setInterval(fetchData, 5 * 60 * 1000);
      }

      // Apply persisted language preference before initialization
      applyLanguage(currentLanguage);
      initialize();
    })();
  </script>

</body>
</html>
