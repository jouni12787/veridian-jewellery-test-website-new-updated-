<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veridian Atelier • Purchase Log</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600;700&display=swap"
    rel="stylesheet"
  >
  <link rel="icon" type="image/jpeg" href="../assets/logo-website-test.jpg">
  <link rel="apple-touch-icon" href="../assets/logo-website-test.jpg">
  <link rel="manifest" href="../manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#2596be">
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' https: data:; connect-src 'self' https://api.gold-api.com; child-src 'self' https://drive.google.com https://*.googleusercontent.com; frame-src 'self' https://drive.google.com https://*.googleusercontent.com; object-src 'none'; base-uri 'self'; frame-ancestors 'self'"
  >
  <script>if (sessionStorage.getItem('authenticated') !== 'true') { window.location.replace('../index.html'); }</script>
  <style>
    :root {
      --pad: 18px;
      --gold-primary: #2596be;
      --gold-secondary: #2596be;
      --gold-dark: #1f7fa0;
      --gold-light: #e6f6fb;
      --ivory: #fafdff;
      --charcoal: #1f2a30;
      --warm-gray: #4f6b78;
      --accent-gold: #2596be;
      --bg: radial-gradient(circle at 10% 0%, rgba(37, 150, 190, 0.15) 0%, rgba(37, 150, 190, 0.05) 55%, #ffffff 100%);
      --glass: rgba(255, 255, 255, 0.92);
      --card-border: rgba(37, 150, 190, 0.3);
      --accent: var(--gold-primary);
      --accent-dark: var(--gold-dark);
      --text: var(--charcoal);
      --muted: var(--warm-gray);
      --shadow: 0 18px 40px -24px rgba(37, 150, 190, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: calc(var(--pad) * 1.2) var(--pad) calc(var(--pad) * 1.6);
    }

    .page {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .brand-logo {
      height: 56px;
      width: auto;
      object-fit: contain;
      filter: drop-shadow(0 6px 16px rgba(37, 150, 190, 0.25));
    }

    .page-nav {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(229, 246, 251, 0.78));
      border: 1px solid rgba(37, 150, 190, 0.25);
      box-shadow: 0 18px 32px -22px rgba(37, 150, 190, 0.45);
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x proximity;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      backdrop-filter: blur(12px);
    }

    .page-nav::-webkit-scrollbar { display: none; }

    .nav-link {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--accent-dark);
      text-decoration: none;
      transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      background: rgba(255, 255, 255, 0.82);
      scroll-snap-align: center;
      min-width: max-content;
      box-shadow: inset 0 0 0 1px rgba(37, 150, 190, 0.12);
    }

    .nav-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.45);
    }

    .nav-link:focus-visible {
      outline: 2px solid rgba(37, 150, 190, 0.55);
      outline-offset: 2px;
    }

    .nav-link:active {
      transform: scale(0.98);
    }

    .nav-link.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      box-shadow: 0 14px 30px -18px rgba(37, 150, 190, 0.6);
    }

    .hero-title {
      margin: 0;
      font-family: 'Playfair Display', 'Times New Roman', serif;
      font-size: clamp(1.6rem, 3.8vw, 2.4rem);
      letter-spacing: 0.02em;
      color: var(--text);
    }

    .hero-subtitle {
      margin: 0;
      font-size: clamp(0.95rem, 2vw, 1.05rem);
      color: var(--muted);
      max-width: 640px;
    }

    .glass-card {
      background: var(--glass);
      border: 1px solid var(--card-border);
      border-radius: 28px;
      padding: clamp(20px, 4vw, 32px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }

    .filter-card {
      display: grid;
      gap: 14px;
    }

    .filter-form {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .filter-input-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    label[for="purchaseDateFilter"] {
      font-weight: 600;
    }

    input[type="date"] {
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid rgba(37, 150, 190, 0.35);
      background: rgba(255, 255, 255, 0.85);
      font: inherit;
      color: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="date"]:focus {
      outline: none;
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 3px rgba(37, 150, 190, 0.25);
    }

    .quick-filters {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .quick-filter-btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.8);
      color: var(--accent-dark);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-filter-btn:hover,
    .quick-filter-btn:focus {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px -18px rgba(37, 150, 190, 0.45);
      outline: none;
    }

    .quick-filter-btn.active {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: #fff;
      box-shadow: 0 14px 30px -20px rgba(37, 150, 190, 0.55);
    }

    .clear-btn {
      margin-left: auto;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: rgba(234, 234, 234, 0.9);
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clear-btn:hover,
    .clear-btn:focus {
      background: rgba(234, 234, 234, 1);
      color: var(--accent-dark);
      outline: none;
    }

    .purchase-stats {
      margin: 0;
      font-weight: 600;
      color: var(--accent-dark);
    }

    .table-card {
      position: relative;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 18px;
      border: 1px solid rgba(37, 150, 190, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.95);
    }

    th,
    td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid rgba(37, 150, 190, 0.12);
    }

    th {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 700;
      background: rgba(37, 150, 190, 0.06);
    }

    tbody tr:hover {
      background: rgba(37, 150, 190, 0.04);
    }

    .loading {
      margin: 0;
      color: var(--muted);
      font-weight: 600;
    }

    .error-message {
      color: #d84a63;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .empty-state {
      margin: 0;
      font-size: 1rem;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      .header-top { justify-content: center; }
      .page-nav {
        width: 100%;
        justify-content: flex-start;
      }
      .brand-logo { height: 46px; }
      body {
        padding: 18px;
      }

      table {
        min-width: 100%;
      }

      th,
      td {
        padding: 12px;
        font-size: 0.9rem;
      }

      td {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 8px;
      }

      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      tr {
        display: grid;
        grid-template-columns: 1fr;
        border-bottom: 1px solid rgba(37, 150, 190, 0.2);
      }

      th {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-top">
        <img src="../assets/logo-website-test.jpg" alt="Veridian Atelier logo" class="brand-logo" />
        <nav class="page-nav" aria-label="Workspace navigation">
          <a class="nav-link" href="./index.html">Scanner</a>
          <a class="nav-link" href="./items.html">Inventory</a>
          <a class="nav-link" href="./sales.html">Sales log</a>
          <a class="nav-link active" href="./purchases.html" aria-current="page">Purchase log</a>
          <a class="nav-link" href="./statement.html">Gold statement</a>
        </nav>
      </div>
      <h1 class="hero-title">Purchase log</h1>
      <p class="hero-subtitle">Audit today&apos;s purchased gold, including karat, weight, and how much was paid for every entry.</p>
    </header>

    <section class="glass-card filter-card" aria-label="Purchase filters">
      <form id="filterForm" class="filter-form" novalidate>
        <label for="purchaseDateFilter">Filter by purchase date</label>
        <div class="filter-input-group">
          <input type="date" id="purchaseDateFilter" name="purchaseDate" />
          <div class="quick-filters" role="group" aria-label="Quick date filters">
            <button type="button" class="quick-filter-btn" data-quick-filter="today">Today</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="yesterday">Yesterday</button>
            <button type="button" class="quick-filter-btn" data-quick-filter="week">This week</button>
          </div>
        </div>
        <button type="button" id="clearFilterBtn" class="clear-btn">Clear</button>
      </form>
      <p id="purchaseStats" class="purchase-stats">Loading purchases…</p>
    </section>

    <section class="glass-card table-card" aria-label="Purchase log">
      <div id="purchaseLoading" class="loading" role="status">Loading purchase history…</div>
      <div id="purchaseError" class="error-message" hidden role="alert"></div>
      <p id="purchaseEmpty" class="empty-state" hidden>No purchases recorded yet.</p>
      <div id="purchaseTableWrapper" class="table-wrapper" hidden>
        <table class="purchase-table">
          <thead>
            <tr>
              <th scope="col">Timestamp</th>
              <th scope="col">Entry type</th>
              <th scope="col">Weight (g)</th>
              <th scope="col">Karat</th>
              <th scope="col">Amount paid</th>
            </tr>
          </thead>
          <tbody id="purchaseTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    (function () {
      const PURCHASES_ENDPOINT = '/api/purchases';
      const filterForm = document.getElementById('filterForm');
      const dateInput = document.getElementById('purchaseDateFilter');
      const quickButtons = Array.from(document.querySelectorAll('.quick-filter-btn'));
      const clearBtn = document.getElementById('clearFilterBtn');
      const statsEl = document.getElementById('purchaseStats');
      const tableBody = document.getElementById('purchaseTableBody');
      const tableWrapper = document.getElementById('purchaseTableWrapper');
      const emptyEl = document.getElementById('purchaseEmpty');
      const loadingEl = document.getElementById('purchaseLoading');
      const errorEl = document.getElementById('purchaseError');

      let allPurchases = [];
      let activeQuickFilter = '';

      const WEEK_LENGTH = 7;

      const KEY_TIMESTAMP = 'Timestamp';
      const KEY_TYPE = 'Type of the input inventory | نوع الجرد المُدخل';
      const KEY_WEIGHT = 'Gold Weight (grams) | وزن الذهب (غرام)';
      const KEY_KARAT = 'Karat (Purity) | العيار';
      const KEY_AMOUNT = 'كمية النقود المدفوعة';

      function normalizeEntry(entry) {
        const normalized = {};
        for (const [key, value] of Object.entries(entry || {})) {
          const trimmedKey = typeof key === 'string' ? key.trim() : key;
          normalized[trimmedKey] = typeof value === 'string' ? value.trim() : value;
        }
        return normalized;
      }

      function parseNumber(value) {
        if (value === null || value === undefined) return null;
        if (typeof value === 'number') return Number.isFinite(value) ? value : null;
        if (typeof value !== 'string') return null;
        const cleaned = value.replace(/[^0-9.,-]/g, '').replace(/,(?=\d{3}(\D|$))/g, '');
        const normalized = cleaned.replace(/,/g, '');
        const parsed = Number.parseFloat(normalized);
        return Number.isFinite(parsed) ? parsed : null;
      }

      function parseTimestamp(value) {
        if (!value || (typeof value === 'string' && !value.trim())) return null;
        if (value instanceof Date) return Number.isNaN(value.getTime()) ? null : value;
        if (typeof value === 'number') {
          const date = new Date(value);
          return Number.isNaN(date.getTime()) ? null : date;
        }
        if (typeof value === 'string') {
          const normalized = value.replace(/\u202f/g, ' ').replace(/\u00a0/g, ' ').trim();
          const isoLike = normalized.replace(' ', 'T');
          const fromISO = new Date(isoLike);
          if (!Number.isNaN(fromISO.getTime())) return fromISO;
          const fallback = new Date(normalized);
          return Number.isNaN(fallback.getTime()) ? null : fallback;
        }
        return null;
      }

      function toDateKey(date) {
        if (!date || Number.isNaN(date.getTime())) return '';
        const year = String(date.getFullYear());
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      function formatDateTime(date) {
        if (!date || Number.isNaN(date.getTime())) return '';
        return date.toLocaleString(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function formatWeight(weight) {
        if (weight === null || weight === undefined || Number.isNaN(weight)) return '—';
        return `${weight.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      function formatAmount(amount) {
        if (amount === null || amount === undefined || Number.isNaN(amount)) return '—';
        return amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function describeFilter(dateStr, quickLabel) {
        if (quickLabel) {
          if (quickLabel === 'today') return 'today';
          if (quickLabel === 'yesterday') return 'yesterday';
          if (quickLabel === 'week') return 'this week';
        }
        if (!dateStr) return '';
        try {
          const date = new Date(`${dateStr}T00:00:00`);
          if (!Number.isNaN(date.getTime())) {
            return date.toLocaleDateString();
          }
        } catch (error) {
          return '';
        }
        return '';
      }

      function renderStats(entries, dateStr, quickLabel) {
        if (!entries.length) {
          const description = describeFilter(dateStr, quickLabel);
          statsEl.textContent = description
            ? `No purchases match the selected filter (${description}).`
            : 'No purchases recorded yet.';
          return;
        }

        const totalWeight = entries.reduce((sum, entry) => sum + (entry.weight || 0), 0);
        const totalAmount = entries.reduce((sum, entry) => sum + (entry.amount || 0), 0);
        const description = describeFilter(dateStr, quickLabel);
        const parts = [`Showing ${entries.length} purchase${entries.length === 1 ? '' : 's'}`];
        if (totalWeight) {
          parts.push(`${totalWeight.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} g total weight`);
        }
        if (totalAmount) {
          parts.push(`${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} total paid`);
        }
        statsEl.textContent = description ? `${parts.join(' • ')} (${description})` : parts.join(' • ');
      }

      function clearTable() {
        while (tableBody.firstChild) {
          tableBody.removeChild(tableBody.firstChild);
        }
      }

      function renderTable(entries) {
        clearTable();
        if (!entries.length) return;
        for (const entry of entries) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td data-label="Timestamp">${entry.timestamp ? formatDateTime(entry.timestamp) : (entry.timestampString || '—')}</td>
            <td data-label="Entry type">${entry.type || '—'}</td>
            <td data-label="Weight (g)">${formatWeight(entry.weight)}</td>
            <td data-label="Karat">${entry.karat || '—'}</td>
            <td data-label="Amount paid">${formatAmount(entry.amount)}</td>
          `;
          tableBody.appendChild(row);
        }
      }

      function setQuickFilterState(active) {
        activeQuickFilter = active;
        quickButtons.forEach((button) => {
          if (button.dataset.quickFilter === active) {
            button.classList.add('active');
            button.setAttribute('aria-pressed', 'true');
          } else {
            button.classList.remove('active');
            button.setAttribute('aria-pressed', 'false');
          }
        });
      }

      function applyFilter({ dateStr = '', quickLabel = '' } = {}) {
        setQuickFilterState(quickLabel);
        if (dateStr) {
          dateInput.value = dateStr;
        } else if (!quickLabel) {
          dateInput.value = '';
        }

        const subset = dateStr
          ? allPurchases.filter((entry) => entry.dateKey === dateStr)
          : quickLabel === 'week'
            ? filterByWeek(allPurchases)
            : allPurchases.slice();

        const hasResults = subset.length > 0;
        renderStats(subset, dateStr, quickLabel);

        if (hasResults) {
          tableWrapper.hidden = false;
          emptyEl.hidden = true;
          renderTable(subset);
        } else {
          tableWrapper.hidden = true;
          emptyEl.hidden = false;
          clearTable();
        }
      }

      function filterByWeek(entries) {
        const now = new Date();
        const start = new Date(now);
        start.setDate(now.getDate() - (WEEK_LENGTH - 1));
        const startKey = toDateKey(start);
        const nowKey = toDateKey(now);
        const validKeys = new Set();
        if (startKey) {
          const startDate = new Date(`${startKey}T00:00:00`);
          for (let i = 0; i < WEEK_LENGTH; i += 1) {
            const temp = new Date(startDate);
            temp.setDate(startDate.getDate() + i);
            const key = toDateKey(temp);
            if (key) validKeys.add(key);
          }
        }
        if (nowKey) validKeys.add(nowKey);
        return entries.filter((entry) => entry.dateKey && validKeys.has(entry.dateKey));
      }

      function setDateToToday() {
        const todayKey = toDateKey(new Date());
        if (todayKey) {
          dateInput.value = todayKey;
        }
      }

      async function fetchPurchases() {
        loadingEl.hidden = false;
        tableWrapper.hidden = true;
        emptyEl.hidden = true;
        errorEl.hidden = true;
        statsEl.textContent = 'Loading purchases…';

        try {
          const response = await fetch(PURCHASES_ENDPOINT, { credentials: 'include' });

          if (response.status === 401) {
            sessionStorage.removeItem('authenticated');
            window.location.replace('../index.html');
            return;
          }

          if (!response.ok) {
            throw new Error(`Failed to load purchases (${response.status})`);
          }

          const payload = await response.json();
          const rawEntries = Array.isArray(payload)
            ? payload
            : Array.isArray(payload?.data)
              ? payload.data
              : Array.isArray(payload?.entries)
                ? payload.entries
                : [];

          if (!Array.isArray(rawEntries)) {
            throw new Error('Unsupported data format received from purchase sheet');
          }

          const parsed = rawEntries
            .map((entry) => {
              const normalized = normalizeEntry(entry);
              const timestampString = normalized[KEY_TIMESTAMP] || normalized.timestamp || '';
              const timestamp = parseTimestamp(timestampString);
              const weight = parseNumber(normalized[KEY_WEIGHT]);
              const amount = parseNumber(normalized[KEY_AMOUNT]);
              const dateKey = timestamp ? toDateKey(timestamp) : '';
              return {
                raw: entry,
                normalized,
                timestamp,
                timestampString,
                dateKey,
                type: normalized[KEY_TYPE] || normalized.type || '',
                weight,
                karat: normalized[KEY_KARAT] || normalized.karat || '',
                amount
              };
            })
            .filter((entry) => entry.timestamp || entry.type || entry.weight || entry.amount);

          parsed.sort((a, b) => {
            const aTime = a.timestamp ? a.timestamp.getTime() : 0;
            const bTime = b.timestamp ? b.timestamp.getTime() : 0;
            return bTime - aTime;
          });

          allPurchases = parsed;

          const todayKey = toDateKey(new Date());
          const hasToday = allPurchases.some((entry) => entry.dateKey === todayKey);

          loadingEl.hidden = true;

          if (!allPurchases.length) {
            statsEl.textContent = 'No purchases recorded yet.';
            emptyEl.hidden = false;
            tableWrapper.hidden = true;
            return;
          }

          if (hasToday && todayKey) {
            applyFilter({ dateStr: todayKey, quickLabel: 'today' });
          } else {
            dateInput.value = '';
            applyFilter();
          }
        } catch (error) {
          console.error('Failed to load purchase log:', error);
          loadingEl.hidden = true;
          tableWrapper.hidden = true;
          emptyEl.hidden = true;
          errorEl.hidden = false;
          errorEl.textContent = error?.message || 'Unable to load purchase history.';
          statsEl.textContent = 'Unable to load purchases.';
        }
      }

      function handleDateChange() {
        const value = dateInput.value;
        setQuickFilterState('');
        applyFilter({ dateStr: value, quickLabel: '' });
      }

      function handleClear() {
        dateInput.value = '';
        applyFilter();
      }

      function handleQuickFilter(event) {
        const { quickFilter } = event.currentTarget.dataset;
        if (!quickFilter) return;

        if (quickFilter === 'today') {
          setDateToToday();
          applyFilter({ dateStr: dateInput.value, quickLabel: 'today' });
          return;
        }

        if (quickFilter === 'yesterday') {
          const date = new Date();
          date.setDate(date.getDate() - 1);
          const key = toDateKey(date);
          if (key) {
            dateInput.value = key;
            applyFilter({ dateStr: key, quickLabel: 'yesterday' });
          }
          return;
        }

        if (quickFilter === 'week') {
          dateInput.value = '';
          applyFilter({ dateStr: '', quickLabel: 'week' });
        }
      }

      filterForm.addEventListener('submit', (event) => event.preventDefault());
      dateInput.addEventListener('change', handleDateChange);
      clearBtn.addEventListener('click', handleClear);
      quickButtons.forEach((button) => button.addEventListener('click', handleQuickFilter));

      setDateToToday();
      fetchPurchases();
    })();
  </script>
</body>
</html>
